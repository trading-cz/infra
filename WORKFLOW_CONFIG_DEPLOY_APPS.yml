name: Deploy Applications (Kafka, ArgoCD, Apps)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
      kubeconfig_run_id:
        description: 'Run ID from infra deployment (for artifact download)'
        required: true
        type: string
      skip_strimzi:
        description: 'Skip Strimzi installation (if already installed)'
        required: false
        type: boolean
        default: false
      skip_argocd:
        description: 'Skip ArgoCD installation (if already installed)'
        required: false
        type: boolean
        default: false

jobs:
  deploy-configs:
    name: Deploy Kubernetes Configurations - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout config repository
        uses: actions/checkout@v4
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'
      
      - name: Download kubeconfig from infra deployment
        uses: actions/download-artifact@v4
        with:
          name: kubeconfig-${{ inputs.environment }}
          path: .
          run-id: ${{ inputs.kubeconfig_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify cluster access
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Verifying cluster access ==="
          kubectl cluster-info
          kubectl get nodes -o wide
          
          echo "=== Current namespaces ==="
          kubectl get namespaces
      
      # =====================================================
      # STRIMZI OPERATOR INSTALLATION
      # =====================================================
      - name: Install Strimzi Operator
        if: ${{ !inputs.skip_strimzi }}
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Creating kafka namespace ==="
          kubectl create namespace kafka --dry-run=client -o yaml | kubectl apply -f -
          
          echo "=== Installing Strimzi Operator ==="
          kubectl create -f 'https://strimzi.io/install/latest?namespace=kafka' -n kafka
          
          echo "=== Waiting for Strimzi Operator to be ready ==="
          kubectl wait --for=condition=ready pod -l name=strimzi-cluster-operator -n kafka --timeout=300s
          
          echo "=== Strimzi Operator installed successfully ==="
          kubectl get pods -n kafka
      
      - name: Strimzi already installed (skipped)
        if: ${{ inputs.skip_strimzi }}
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          echo "‚ÑπÔ∏è Skipping Strimzi installation as requested"
          kubectl get pods -n kafka || echo "Warning: kafka namespace not found"
      
      # =====================================================
      # KAFKA CLUSTER DEPLOYMENT
      # =====================================================
      - name: Apply Kafka Cluster Configuration
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Applying Kafka cluster configuration ==="
          # Path depends on new repo structure: overlays/dev/kafka or kubernetes/overlays/dev/kafka
          # Assuming kubernetes/ directory is moved to root, so: overlays/
          kubectl apply -k overlays/${{ inputs.environment }}/kafka
          
          echo "=== Waiting for Kafka cluster to be ready (this may take 5-10 minutes) ==="
          kubectl wait kafka/trading-cluster --for=condition=Ready --timeout=600s -n kafka || true
          
          echo "=== Kafka cluster status ==="
          kubectl get kafka -n kafka
          kubectl get pods -n kafka
      
      # =====================================================
      # APPLICATION NAMESPACES
      # =====================================================
      - name: Create application namespaces
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Creating application namespaces ==="
          kubectl create namespace ingestion --dry-run=client -o yaml | kubectl apply -f -
          kubectl create namespace strategies --dry-run=client -o yaml | kubectl apply -f -
          
          echo "=== Namespaces created ==="
          kubectl get namespaces
      
      # =====================================================
      # ARGOCD INSTALLATION
      # =====================================================
      - name: Install ArgoCD
        if: ${{ !inputs.skip_argocd }}
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Creating argocd namespace ==="
          kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
          
          echo "=== Installing ArgoCD ==="
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/core-install.yaml
          
          echo "=== Waiting for ArgoCD to be ready ==="
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-application-controller -n argocd --timeout=300s
          
          echo "=== ArgoCD installed successfully ==="
          kubectl get pods -n argocd
      
      - name: ArgoCD already installed (skipped)
        if: ${{ inputs.skip_argocd }}
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          echo "‚ÑπÔ∏è Skipping ArgoCD installation as requested"
          kubectl get pods -n argocd || echo "Warning: argocd namespace not found"
      
      # =====================================================
      # ARGOCD APP-OF-APPS CONFIGURATION
      # =====================================================
      - name: Configure ArgoCD App-of-Apps
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          # Determine branch based on environment
          if [ "${{ inputs.environment }}" == "dev" ]; then
            BRANCH="main"
          else
            BRANCH="production"
          fi
          
          echo "=== Configuring ArgoCD for environment: ${{ inputs.environment }} (branch: ${BRANCH}) ==="
          
          # Deploy parent app-of-apps application
          # NOTE: repoURL should point to trading-cz/config (NEW REPO)
          # NOTE: path should be overlays/{env}/app-of-apps (no kubernetes/ prefix)
          cat <<EOF | kubectl apply -f -
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: trading-system-${{ inputs.environment }}
            namespace: argocd
            finalizers:
              - resources-finalizer.argocd.argoproj.io
          spec:
            project: default
            source:
              repoURL: 'https://github.com/trading-cz/config.git'
              targetRevision: ${BRANCH}
              path: overlays/${{ inputs.environment }}/app-of-apps
            destination:
              server: 'https://kubernetes.default.svc'
              namespace: default
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - CreateNamespace=true
          EOF
          
          echo "=== ArgoCD parent application created ==="
          kubectl get applications -n argocd
      
      # =====================================================
      # WAIT FOR ARGOCD SYNC
      # =====================================================
      - name: Wait for ArgoCD to Sync Applications
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Waiting for ArgoCD to sync child applications ==="
          sleep 30
          
          echo "=== ArgoCD Application Status ==="
          kubectl get applications -n argocd -o wide
          
          echo "=== All Pods Across Namespaces ==="
          kubectl get pods -A
      
      # =====================================================
      # DEPLOYMENT SUMMARY
      # =====================================================
      - name: Deployment Summary
        if: always()
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "## üéâ Kubernetes Configuration Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚úÖ Deployed Components" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ inputs.skip_strimzi }}" == "false" ]; then
              echo "- ‚úÖ Strimzi Operator" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚è≠Ô∏è Strimzi Operator (skipped)" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "- ‚úÖ Kafka Cluster (3 brokers, KRaft mode)" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ inputs.skip_argocd }}" == "false" ]; then
              echo "- ‚úÖ ArgoCD (GitOps Controller)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚è≠Ô∏è ArgoCD (skipped)" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "- ‚úÖ ArgoCD Parent Application (App-of-Apps)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Application Namespaces (ingestion, strategies)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### üåê Kafka Access" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Internal (from pods):**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "trading-cluster-kafka-bootstrap.kafka:9092" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**External (from internet):**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "# Get kafka-0 external IP from infra deployment summary" >> $GITHUB_STEP_SUMMARY
            echo "<kafka-0-ip>:32100" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### üîÑ GitOps (ArgoCD)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ inputs.environment }}" == "dev" ]; then
              echo "- **Tracking Branch**: \`main\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Tracking Branch**: \`production\`" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- **Auto-Sync**: ‚úÖ Enabled" >> $GITHUB_STEP_SUMMARY
            echo "- **Self-Heal**: ‚úÖ Enabled" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Push changes to the tracked branch to automatically deploy updates!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### üìä Verify Deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# Check ArgoCD applications" >> $GITHUB_STEP_SUMMARY
            echo "kubectl get applications -n argocd" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Check Kafka cluster" >> $GITHUB_STEP_SUMMARY
            echo "kubectl get kafka -n kafka" >> $GITHUB_STEP_SUMMARY
            echo "kubectl get pods -n kafka" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Check applications" >> $GITHUB_STEP_SUMMARY
            echo "kubectl get pods -n ingestion" >> $GITHUB_STEP_SUMMARY
            echo "kubectl get pods -n strategies" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### üìù Current Status" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get applications -n argocd -o wide 2>/dev/null || echo "No applications found"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### üîó Related Resources" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [Infrastructure Repository](https://github.com/trading-cz/infra)" >> $GITHUB_STEP_SUMMARY
            echo "- [Config Repository](https://github.com/trading-cz/config)" >> $GITHUB_STEP_SUMMARY
          fi
