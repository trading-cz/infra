name: Debug Cluster

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to debug'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

jobs:
  debug:
    name: Gather Cluster Logs
    runs-on: ubuntu-latest
    steps:
      - name: Install hcloud CLI
        run: |
          curl -fsSL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar -xz
          sudo mv hcloud /usr/local/bin/
          hcloud version

      - name: Discover IPs
        id: discover
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          echo "üîç Discovering Server IPs..."
          
          # Get Control Plane IP (k3s-control)
          CONTROL_IP=$(hcloud server list -o columns=ipv4,name -o noheader | grep "k3s-control" | awk '{print $1}')
          
          # Get Kafka IP (kafka-0)
          KAFKA_IP=$(hcloud server list -o columns=ipv4,name -o noheader | grep "kafka-0" | awk '{print $1}')
          
          if [ -z "$CONTROL_IP" ]; then
            echo "‚ùå Could not find k3s-control server"
            exit 1
          fi
          
          echo "‚úÖ Found Control Plane: $CONTROL_IP"
          echo "‚úÖ Found Kafka Node: $KAFKA_IP"
          
          echo "control_plane_ip=$CONTROL_IP" >> $GITHUB_OUTPUT
          echo "kafka_ip=$KAFKA_IP" >> $GITHUB_OUTPUT

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Download Kubeconfig
        env:
          CONTROL_IP: ${{ steps.discover.outputs.control_plane_ip }}
        run: |
          mkdir -p ~/.kube
          echo "üì• Downloading kubeconfig from $CONTROL_IP..."
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@$CONTROL_IP "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config 2>/dev/null; then
            sed -i "s/127.0.0.1/$CONTROL_IP/g" ~/.kube/config
            chmod 600 ~/.kube/config
            echo "‚úÖ Kubeconfig downloaded"
          else
            echo "‚ùå Failed to download kubeconfig"
            exit 1
          fi

      - name: Run Diagnostics
        env:
          CONTROL_IP: ${{ steps.discover.outputs.control_plane_ip }}
          KAFKA_IP: ${{ steps.discover.outputs.kafka_ip }}
        run: |
          echo "======================================================="
          echo "üîç COMPREHENSIVE DEBUGGING REPORT"
          echo "======================================================="
          
          echo "::group::1. Host Port Check (OS Level)"
          echo "Checking what is actually listening on the nodes..."
          echo "--- Control Plane ($CONTROL_IP) ---"
          ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "ss -tulpn | grep -E ':(30443|30002|30080)' || echo '‚ùå Ports not found in ss output'"
          
          if [ -n "$KAFKA_IP" ]; then
            echo "--- Kafka Node ($KAFKA_IP) ---"
            ssh -o StrictHostKeyChecking=no root@$KAFKA_IP "ss -tulpn | grep -E ':(30443|30002|30080)' || echo '‚ùå Ports not found in ss output'"
          fi
          echo "::endgroup::"

          echo "::group::2. Cluster State (Nodes & Pods)"
          kubectl get nodes -o wide
          echo "---------------------------------------------------"
          kubectl get pods -A -o wide
          echo "::endgroup::"

          echo "::group::3. Service Connectivity (Services & Endpoints)"
          echo "Checking if Services have active Endpoints (Pods)..."
          kubectl get svc -A -o wide
          echo "---------------------------------------------------"
          kubectl get endpoints -A
          echo "::endgroup::"

          echo "::group::4. ArgoCD Diagnostics (Ingress & CR)"
          echo "Ingress Definition:"
          kubectl get ingress -n argocd -o yaml
          echo "---------------------------------------------------"
          echo "ArgoCD CR Status:"
          kubectl get argocd -n argocd -o yaml || echo "ArgoCD CR not found"
          echo "---------------------------------------------------"
          echo "Traefik Logs (Routing Errors):"
          kubectl logs -n kube-system -l app.kubernetes.io/name=traefik --tail=50
          echo "---------------------------------------------------"
          echo "ArgoCD Server Logs:"
          kubectl logs -n argocd -l app.kubernetes.io/name=trading-argocd-server --tail=50
          echo "---------------------------------------------------"
          echo "ArgoCD Namespace Events:"
          kubectl get events -n argocd --sort-by='.lastTimestamp'
          echo "::endgroup::"

          echo "::group::5. Kafka Diagnostics (Broker & CR)"
          echo "Kafka Service Definition:"
          kubectl get svc -n kafka -o yaml
          echo "---------------------------------------------------"
          echo "Kafka CR Status:"
          kubectl get kafka -n kafka -o yaml || echo "Kafka CR not found"
          echo "---------------------------------------------------"
          echo "Kafka Broker Logs (Startup & Listeners):"
          kubectl logs -n kafka -l strimzi.io/name=trading-cluster-dual-role --tail=100
          echo "---------------------------------------------------"
          echo "Strimzi Operator Logs:"
          kubectl logs -n kafka -l name=strimzi-cluster-operator --tail=50
          echo "---------------------------------------------------"
          echo "Kafka Namespace Events:"
          kubectl get events -n kafka --sort-by='.lastTimestamp'
          echo "::endgroup::"
