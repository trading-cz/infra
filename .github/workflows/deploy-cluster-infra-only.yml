name: Deploy K3s Cluster (Infrastructure Only)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod

env:
  TF_VERSION: '1.13.4'

jobs:
  terraform:
    name: Deploy Infrastructure - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    defaults:
      run:
        working-directory: ./terraform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Create SSH key files
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_ed25519.pub
          chmod 600 ~/.ssh/id_ed25519
          chmod 644 ~/.ssh/id_ed25519.pub
  
      - name: Terraform Init
        run: terraform init
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
      
      - name: Terraform Validate
        run: terraform validate
      
      - name: Terraform Plan
        run: |
          terraform plan \
            -var-file="environments/${{ inputs.environment }}.tfvars" \
            -var="hcloud_token=${{ secrets.HCLOUD_TOKEN }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var="ssh_private_key=${{ secrets.SSH_PRIVATE_KEY }}" \
            -out=tfplan
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
      
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
      
      - name: Save Terraform outputs
        id: tf_outputs
        run: |
          echo "control_plane_ip=$(terraform output -raw control_plane_ip)" >> $GITHUB_OUTPUT
          echo "kafka_external_ip=$(terraform output -raw kafka_external_ip)" >> $GITHUB_OUTPUT
          echo "kafka_external_primary_ip_id=$(terraform output -raw kafka_external_primary_ip_id)" >> $GITHUB_OUTPUT
          echo "kafka_node_0_id=$(terraform output -raw kafka_node_0_id)" >> $GITHUB_OUTPUT
          terraform output -json > outputs.json
      
      - name: Assign Primary IP to kafka-0
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          KAFKA_NODE_0_ID="${{ steps.tf_outputs.outputs.kafka_node_0_id }}"
          PRIMARY_IP_ID="${{ steps.tf_outputs.outputs.kafka_external_primary_ip_id }}"
          KAFKA_EXTERNAL_IP="${{ steps.tf_outputs.outputs.kafka_external_ip }}"
          
          echo "=== Assigning Primary IP #2 (${KAFKA_EXTERNAL_IP}) to kafka-0 ==="
          echo "Server ID: ${KAFKA_NODE_0_ID}"
          echo "Primary IP ID: ${PRIMARY_IP_ID}"
          
          # Install hcloud CLI
          curl -fsSL https://github.com/hetznercloud/cli/releases/download/v1.47.0/hcloud-linux-amd64.tar.gz | tar -xz
          chmod +x hcloud
          
          # Power off kafka-0 (required for IP assignment)
          echo "Powering off kafka-0..."
          ./hcloud server poweroff ${KAFKA_NODE_0_ID}
          
          # Wait for power off
          echo "Waiting for shutdown..."
          sleep 10
          
          # Assign Primary IP
          echo "Assigning Primary IP..."
          ./hcloud primary-ip assign --server ${KAFKA_NODE_0_ID} ${PRIMARY_IP_ID}
          
          # Power on kafka-0
          echo "Powering on kafka-0..."
          ./hcloud server poweron ${KAFKA_NODE_0_ID}
          
          # Wait for boot
          echo "Waiting for kafka-0 to boot..."
          sleep 30
          
          echo "âœ… Primary IP #2 successfully assigned to kafka-0!"
          echo "   Kafka external IP: ${KAFKA_EXTERNAL_IP}"
            
      - name: Fetch kubeconfig
        run: |
          CONTROL_IP="${{ steps.tf_outputs.outputs.control_plane_ip }}"
          
          # Wait for SSH to be available
          echo "Waiting for SSH on $CONTROL_IP..."
          for i in {1..60}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i ~/.ssh/id_ed25519 root@$CONTROL_IP "echo 'SSH ready'" 2>/dev/null; then
              echo "SSH connection successful!"
              break
            fi
            echo "Attempt $i/60: SSH not ready yet, waiting..."
            sleep 10
          done
          
          # Fetch kubeconfig
          echo "Fetching kubeconfig from $CONTROL_IP..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 root@$CONTROL_IP "cat /etc/rancher/k3s/k3s.yaml" > kubeconfig-temp.yaml
          
          # Replace localhost with actual IP
          sed "s/127.0.0.1/$CONTROL_IP/g" kubeconfig-temp.yaml > kubeconfig.yaml
          
          echo "Kubeconfig fetched successfully!"
          chmod 600 kubeconfig.yaml
      
      - name: Upload kubeconfig
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig-${{ inputs.environment }}
          path: ./terraform/kubeconfig.yaml
          retention-days: 90
      
      - name: Verify cluster
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Cluster Info ==="
          kubectl cluster-info
          
          echo -e "\n=== Nodes ==="
          kubectl get nodes -o wide
          
          echo -e "\n=== System Pods ==="
          kubectl get pods -A
      
      - name: Infrastructure Deployment Summary
        if: always()
        run: |
          echo "## ðŸ—ï¸ Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**K3s Cluster**:" >> $GITHUB_STEP_SUMMARY
            echo "- 1 Control Plane (CPX21)" >> $GITHUB_STEP_SUMMARY
            echo "- 3 Kafka Workers (CPX31)" >> $GITHUB_STEP_SUMMARY
            echo "- Private Network: 10.0.1.0/24" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Persistent Primary IPs" >> $GITHUB_STEP_SUMMARY
            echo "- **Control Plane**: \`${{ steps.tf_outputs.outputs.control_plane_ip }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Kafka External**: \`${{ steps.tf_outputs.outputs.kafka_external_ip }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Cost: â‚¬1.00/month (persists after VM destruction)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¥ Kubeconfig" >> $GITHUB_STEP_SUMMARY
            echo "Download the \`kubeconfig-${{ inputs.environment }}\` artifact to access the cluster." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# Download artifact, then:" >> $GITHUB_STEP_SUMMARY
            echo "export KUBECONFIG=./kubeconfig.yaml" >> $GITHUB_STEP_SUMMARY
            echo "kubectl get nodes" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### â­ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Deploy Kubernetes Configurations:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ Go to [\`trading-cz/config\`](https://github.com/trading-cz/config) repository" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run the **Deploy Applications** workflow with:" >> $GITHUB_STEP_SUMMARY
            echo "- Environment: \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Kubeconfig artifact: \`kubeconfig-${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This will install:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Strimzi Operator" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Kafka Cluster (3 brokers)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ArgoCD (GitOps)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Trading Applications" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’° Cost Management" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To Destroy VMs (daily cleanup):**" >> $GITHUB_STEP_SUMMARY
            echo "- Use **hcloud-maintenance** workflow" >> $GITHUB_STEP_SUMMARY
            echo "- Action: \`destroy-cluster\`" >> $GITHUB_STEP_SUMMARY
            echo "- Keeps Primary IPs for next deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To Destroy Everything:**" >> $GITHUB_STEP_SUMMARY
            echo "- Use **hcloud-maintenance** workflow" >> $GITHUB_STEP_SUMMARY
            echo "- Action: \`destroy-all\`" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸ Deletes Primary IPs (cannot be recovered)" >> $GITHUB_STEP_SUMMARY
          fi
