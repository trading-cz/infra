# MegaLinter GitHub Action configuration file
# More info at https://megalinter.io
---
name: MegaLinter

# Trigger mega-linter at every push. Action will also be visible from Pull Requests
on:
  workflow_dispatch:  # Allow manual trigger from Actions tab

  pull_request:
    branches:
      - main
      - production
    paths:
      # Trigger only when Terraform files change anywhere in the repo
      - '**/*.tf'
      - '**/*.tfvars'

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  megalinter:
    name: MegaLinter
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      # Cache Docker images (helps with rapid commits)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # MegaLinter
      - name: MegaLinter
        # Using terraform flavor for optimized Terraform linting
        # More info at https://megalinter.io/latest/flavors/
        # v9 includes improved stability & terraform-fmt v1.13.3+
        uses: oxsecurity/megalinter/flavors/terraform@v9
        id: ml
        # All available variables are described in documentation
        # https://megalinter.io/latest/config-file/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Validate all source code when not in PR mode
          VALIDATE_ALL_CODEBASE: ${{ github.event_name != 'pull_request' }}
          # Show only errors in CI to reduce noise
          LOG_LEVEL: WARNING
          # TFLint configuration - prevent plugin download issues
          TERRAFORM_TFLINT_UNSECURED_ENV_VARIABLES: GITHUB_TOKEN
          # Terraform version to use
          TERRAFORM_TERRAFORM_VERSION: '1.13.4'
          # Disable linters with known issues
          DISABLE_LINTERS: JSON_ESLINT_PLUGIN_JSONC,MAKEFILE_CHECKMAKE,MARKDOWN_REMARK_LINT

      # Upload MegaLinter artifacts
      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: MegaLinter reports
          path: |
            megalinter-reports
            mega-linter.log
