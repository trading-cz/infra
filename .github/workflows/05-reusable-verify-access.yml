name: 'Reusable: Verify External Access'

on:
  workflow_call:
    inputs:
      control_plane_ip:
        description: 'Control Plane IP (ArgoCD)'
        required: true
        type: string
      kafka_ip:
        description: 'Kafka Node IP'
        required: true
        type: string
    secrets:
      ssh_private_key:
        description: 'SSH private key for server access'
        required: true

jobs:
  verify-access:
    name: Verify External Access
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ssh_private_key }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Download Kubeconfig
        run: |
          CONTROL_IP="${{ inputs.control_plane_ip }}"
          mkdir -p ~/.kube
          
          echo "üì• Downloading kubeconfig from $CONTROL_IP..."
          for i in {1..5}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@$CONTROL_IP "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config 2>/dev/null; then
              sed -i "s/127.0.0.1/$CONTROL_IP/g" ~/.kube/config
              chmod 600 ~/.kube/config
              echo "‚úÖ Kubeconfig downloaded"
              break
            fi
            echo "‚ö†Ô∏è Retry $i/5..."
            sleep 5
          done

      - name: Install kcat (kafkacat)
        run: |
          sudo apt-get update
          sudo apt-get install -y kafkacat

      - name: Verify ArgoCD UI (HTTPS)
        id: argocd
        continue-on-error: true
        run: |
          echo "üåê Checking ArgoCD UI at https://${{ inputs.control_plane_ip }}:30443..."
          # -k allows insecure (self-signed cert), -f fails on 404/500 errors
          if curl -k -f --connect-timeout 10 "https://${{ inputs.control_plane_ip }}:30443"; then
            echo "‚úÖ ArgoCD UI is accessible!"
          else
            echo "‚ùå Failed to access ArgoCD UI"
            exit 1
          fi

      - name: Verify Kafka External Access
        id: kafka
        continue-on-error: true
        run: |
          echo "üêò Checking Kafka Broker at ${{ inputs.kafka_ip }}:33333..."
          # -L: Metadata list mode
          # -b: Broker list
          # -t: Timeout (5s)
          if kcat -L -b "${{ inputs.kafka_ip }}:33333" -t 5000; then
            echo "‚úÖ Kafka Broker is accessible externally!"
          else
            echo "‚ùå Failed to connect to Kafka Broker"
            echo "   Possible causes: Firewall closed, NodePort not listening, or Advertised Listener mismatch."
            exit 1
          fi

      - name: Check Verification Results
        if: always()
        run: |
          echo "========================================"
          echo "  Verification Results"
          echo "========================================"
          FAILED=false
          
          if [ "${{ steps.argocd.outcome }}" == "success" ]; then
            echo "‚úÖ ArgoCD: Accessible"
          else
            echo "‚ùå ArgoCD: FAILED"
            FAILED=true
          fi
          
          if [ "${{ steps.kafka.outcome }}" == "success" ]; then
            echo "‚úÖ Kafka:  Accessible"
          else
            echo "‚ùå Kafka:  FAILED"
            FAILED=true
          fi
          
          echo "========================================"
          if [ "$FAILED" = true ]; then
            exit 1
          fi

      - name: Debug on Failure
        if: failure()
        run: |
          echo "‚ùå Verification Failed. Dumping Cluster State..."
          
          echo "::group::CRD Status"
          kubectl get crd | grep -E 'argocd|kafka|strimzi'
          echo "::endgroup::"

          echo "::group::ArgoCD CR Status"
          kubectl get argocd -n argocd -o yaml || echo "ArgoCD CR not found"
          echo "::endgroup::"

          echo "::group::Kafka CR Status"
          kubectl get kafka -n kafka -o yaml || echo "Kafka CR not found"
          echo "::endgroup::"

          echo "::group::ArgoCD Operator Logs"
          kubectl logs -n argocd-operator-system -l control-plane=controller-manager --tail=200 || echo "ArgoCD Operator logs not found"
          echo "::endgroup::"

          echo "::group::Strimzi Operator Logs"
          kubectl logs -n kafka -l name=strimzi-cluster-operator --tail=200 || echo "Strimzi Operator logs not found"
          echo "::endgroup::"

          echo "::group::Namespace Events (ArgoCD)"
          kubectl get events -n argocd --sort-by='.lastTimestamp'
          echo "::endgroup::"

          echo "::group::Namespace Events (Kafka)"
          kubectl get events -n kafka --sort-by='.lastTimestamp'
          echo "::endgroup::"

          echo "::group::Node Status"
          kubectl get nodes -o wide
          echo "::endgroup::"

          echo "::group::All Pods"
          kubectl get pods -A -o wide
          echo "::endgroup::"

          echo "::group::Traefik Service (NodePort Check)"
          kubectl get svc -n kube-system -l app.kubernetes.io/name=traefik -o wide
          echo "::endgroup::"

          echo "::group::ArgoCD Service & Ingress"
          kubectl get svc -n argocd
          kubectl get ingress -n argocd
          echo "::endgroup::"

          echo "::group::Kafka Services"
          kubectl get svc -n kafka -o wide
          echo "::endgroup::"
