name: '05 Reusable: Verify External Access'

on:
  workflow_call:
    inputs:
      control_plane_ip:
        description: 'Control Plane IP (ArgoCD)'
        required: true
        type: string
      kafka_ip:
        description: 'Kafka Node IP'
        required: true
        type: string
    secrets:
      ssh_private_key:
        description: 'SSH private key for server access'
        required: true

jobs:
  verify-access:
    name: Verify External Access
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ssh_private_key }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Download Kubeconfig
        run: |
          CONTROL_IP="${{ inputs.control_plane_ip }}"
          mkdir -p ~/.kube
          
          echo "üì• Downloading kubeconfig from $CONTROL_IP..."
          for i in {1..5}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@$CONTROL_IP "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config 2>/dev/null; then
              sed -i "s/127.0.0.1/$CONTROL_IP/g" ~/.kube/config
              chmod 600 ~/.kube/config
              echo "‚úÖ Kubeconfig downloaded"
              break
            fi
            echo "‚ö†Ô∏è Retry $i/5..."
            sleep 5
          done

      - name: Install kcat (kafkacat)
        run: |
          sudo apt-get update
          sudo apt-get install -y kafkacat

      - name: Verify ArgoCD UI (HTTPS)
        id: argocd
        continue-on-error: true
        run: |
          URL="https://${{ inputs.control_plane_ip }}:30443"
          echo "üåê Checking ArgoCD UI at $URL..."
          # -k allows insecure (self-signed cert), -f fails on 404/500 errors
          # We removed -H "Host: argocd.local" to verify access via IP directly
          if curl -k -f --connect-timeout 10 "$URL"; then
            echo "‚úÖ ArgoCD UI is accessible!"
            # Add clickable link to Job Summary
            echo "### üöÄ ArgoCD Access" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ UI is accessible at: **[$URL]($URL)**" >> $GITHUB_STEP_SUMMARY
            echo "> Note: You will see a security warning because of the self-signed certificate." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Failed to access ArgoCD UI"
            exit 1
          fi

      - name: Verify Kafka External Access
        id: kafka
        continue-on-error: true
        run: |
          echo "üêò Checking Kafka Broker at ${{ inputs.kafka_ip }}:30002..."
          
          # Wait for Entity Operator to create topics (may take 30-60s after Kafka is ready)
          echo "‚è≥ Waiting for Kafka topics to be created by Entity Operator..."
          for i in {1..12}; do
            TOPICS=$(kcat -L -b "${{ inputs.kafka_ip }}:30002" 2>/dev/null | grep "topic" | grep -v "Metadata" || true)
            if echo "$TOPICS" | grep -q "event"; then
              echo "‚úÖ Topic 'event' found!"
              break
            fi
            echo "Waiting for topics... ($i/12)"
            sleep 10
          done
          
          # Final metadata check
          if kcat -L -b "${{ inputs.kafka_ip }}:30002"; then
            echo "‚úÖ Kafka Broker is accessible externally!"
          else
            echo "‚ùå Failed to connect to Kafka Broker"
            echo "   Possible causes: Firewall closed, NodePort not listening, or Advertised Listener mismatch."
            exit 1
          fi

      - name: Check Verification Results
        if: always()
        run: |
          echo "========================================"
          echo "  Verification Results"
          echo "========================================"
          FAILED=false
          
          if [ "${{ steps.argocd.outcome }}" == "success" ]; then
            echo "‚úÖ ArgoCD: Accessible"
          else
            echo "‚ùå ArgoCD: FAILED"
            FAILED=true
          fi
          
          if [ "${{ steps.kafka.outcome }}" == "success" ]; then
            echo "‚úÖ Kafka:  Accessible"
          else
            echo "‚ùå Kafka:  FAILED"
            FAILED=true
          fi
          
          echo "========================================"
          if [ "$FAILED" = true ]; then
            exit 1
          fi

      - name: Debug on Failure
        if: failure()
        run: |
          echo "======================================================="
          echo "üîç COMPREHENSIVE DEBUGGING REPORT"
          echo "======================================================="
          
          CONTROL_IP="${{ inputs.control_plane_ip }}"
          KAFKA_IP="${{ inputs.kafka_ip }}"

          echo "::group::1. Host Port Check (OS Level)"
          echo "Checking what is actually listening on the nodes..."
          echo "--- Control Plane ($CONTROL_IP) ---"
          ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "ss -tulpn | grep -E ':(30443|30002|30080)' || echo '‚ùå Ports not found in ss output'"
          
          echo "--- Kafka Node ($KAFKA_IP) ---"
          ssh -o StrictHostKeyChecking=no root@$KAFKA_IP "ss -tulpn | grep -E ':(30443|30002|30080)' || echo '‚ùå Ports not found in ss output'"
          echo "::endgroup::"

          echo "::group::2. Cluster State (Nodes & Pods)"
          kubectl get nodes -o wide
          echo "---------------------------------------------------"
          kubectl get pods -A -o wide
          echo "::endgroup::"

          echo "::group::3. Service Connectivity (Services & Endpoints)"
          echo "Checking if Services have active Endpoints (Pods)..."
          kubectl get svc -A -o wide
          echo "---------------------------------------------------"
          kubectl get endpoints -A
          echo "::endgroup::"

          echo "::group::4. ArgoCD Diagnostics (Ingress & CR)"
          echo "Ingress Definition:"
          kubectl get ingress -n argocd -o yaml
          echo "---------------------------------------------------"
          echo "ArgoCD CR Status:"
          kubectl get argocd -n argocd -o yaml || echo "ArgoCD CR not found"
          echo "---------------------------------------------------"
          echo "Traefik Logs (Routing Errors):"
          kubectl logs -n kube-system -l app.kubernetes.io/name=traefik --tail=50
          echo "---------------------------------------------------"
          echo "ArgoCD Server Logs:"
          kubectl logs -n argocd -l app.kubernetes.io/name=trading-argocd-server --tail=50
          echo "---------------------------------------------------"
          echo "ArgoCD Namespace Events:"
          kubectl get events -n argocd --sort-by='.lastTimestamp'
          echo "::endgroup::"

          echo "::group::5. Kafka Diagnostics (Broker & CR)"
          echo "Kafka Service Definition:"
          kubectl get svc -n kafka -o yaml
          echo "---------------------------------------------------"
          echo "Kafka CR Status:"
          kubectl get kafka -n kafka -o yaml || echo "Kafka CR not found"
          echo "---------------------------------------------------"
          echo "Kafka Pods (3 brokers expected for KRaft quorum):"
          kubectl get pods -n kafka -o wide
          echo "---------------------------------------------------"
          echo "Kafka Broker Logs (Startup & Listeners):"
          kubectl logs -n kafka -l strimzi.io/name=trading-cluster-dual-role --tail=100
          echo "---------------------------------------------------"
          echo "Strimzi Operator Logs:"
          kubectl logs -n kafka -l name=strimzi-cluster-operator --tail=50
          echo "---------------------------------------------------"
          echo "Kafka Namespace Events:"
          kubectl get events -n kafka --sort-by='.lastTimestamp'
          echo "::endgroup::"
          
          echo "::group::6. Kafka Node Status (All 3 Kafka K3s Nodes)"
          echo "Kafka nodes in cluster:"
          kubectl get nodes -l workload=kafka -o wide
          echo "---------------------------------------------------"
          echo "Node conditions:"
          kubectl describe nodes -l workload=kafka | grep -A5 "Conditions:" || true
          echo "::endgroup::"
