name: '07 Verify Monitoring Stack - Full Health Check'

on:
  workflow_dispatch:
    inputs:
      control_plane_ip:
        description: 'Control Plane IP (if known)'
        required: false
        type: string
      environment:
        description: 'Environment to verify'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  verify-monitoring-stack:
    name: Verify Complete Monitoring Stack
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Get Control Plane IP (from Hetzner API if not provided)
        id: get_ip
        if: ${{ !inputs.control_plane_ip }}
        run: |
          HCLOUD_TOKEN="${{ secrets.HCLOUD_TOKEN }}"
          ENV="${{ inputs.environment }}"
          
          echo "ğŸ“¡ Fetching control plane IP from Hetzner Cloud..."
          CONTROL_IP=$(curl -s -H "Authorization: Bearer $HCLOUD_TOKEN" \
            https://api.hetzner.cloud/v1/servers | \
            jq -r ".servers[] | select(.name | contains(\"k3s-control-$ENV\")) | .public_net.ipv4.ip" | \
            head -1)
          
          if [ -z "$CONTROL_IP" ]; then
            echo "âŒ Could not find control plane IP in Hetzner Cloud"
            exit 1
          fi
          
          echo "control_ip=$CONTROL_IP" >> $GITHUB_OUTPUT
          echo "âœ… Found control plane IP: $CONTROL_IP"

      - name: Set Control Plane IP
        id: control_ip
        run: |
          if [ -n "${{ inputs.control_plane_ip }}" ]; then
            echo "ip=${{ inputs.control_plane_ip }}" >> $GITHUB_OUTPUT
          else
            echo "ip=${{ steps.get_ip.outputs.control_ip }}" >> $GITHUB_OUTPUT
          fi

      - name: Download Kubeconfig
        run: |
          CONTROL_IP="${{ steps.control_ip.outputs.ip }}"
          mkdir -p ~/.kube
          
          echo "ğŸ“¥ Downloading kubeconfig from $CONTROL_IP..."
          for i in {1..5}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@$CONTROL_IP "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config 2>/dev/null; then
              sed -i "s/127.0.0.1/$CONTROL_IP/g" ~/.kube/config
              chmod 600 ~/.kube/config
              echo "âœ… Kubeconfig downloaded"
              break
            fi
            echo "âš ï¸  Retry $i/5..."
            sleep 5
          done

      - name: Verify Kubernetes Cluster
        run: |
          echo "ğŸ” Checking Kubernetes cluster..."
          kubectl cluster-info || exit 1
          kubectl get nodes -o wide
          echo "âœ… Kubernetes cluster is accessible"

      - name: Verify ArgoCD Deployment
        id: argocd_check
        continue-on-error: true
        run: |
          echo "ğŸ” Checking ArgoCD..."
          kubectl get deployment -n argocd argocd-server -o wide
          
          if kubectl wait --for=condition=Available deployment/argocd-server -n argocd --timeout=30s 2>/dev/null; then
            echo "âœ… ArgoCD deployment is ready"
            ARGOCD_READY=true
          else
            echo "âš ï¸  ArgoCD deployment not ready yet"
            ARGOCD_READY=false
          fi
          echo "ready=$ARGOCD_READY" >> $GITHUB_OUTPUT

      - name: Verify ArgoCD Applications Status
        continue-on-error: true
        run: |
          echo "ğŸ“‹ Checking ArgoCD Applications..."
          
          APPS=("monitoring" "kafka" "ingestion")
          for app in "${APPS[@]}"; do
            echo ""
            echo "Checking Application: $app"
            STATUS=$(kubectl get application $app -n argocd -o jsonpath='{.status.operationState.phase}' 2>/dev/null || echo "NOT_FOUND")
            SYNC=$(kubectl get application $app -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "UNKNOWN")
            
            if [ "$SYNC" == "Synced" ]; then
              echo "âœ… $app: Synced"
            else
              echo "â³ $app: Sync status = $SYNC"
            fi
          done

      - name: Verify Prometheus Operator & Instance
        id: prometheus_check
        run: |
          echo "ğŸ” Checking Prometheus..."
          
          # Check Prometheus operator
          if kubectl get pod -n monitoring -l "app=kube-prometheus-stack-operator" -o wide; then
            echo "âœ… Prometheus Operator is running"
          else
            echo "âŒ Prometheus Operator not found"
            exit 1
          fi
          
          # Wait for Prometheus instance
          echo "â³ Waiting for Prometheus instance..."
          if kubectl wait --for=condition=Ready pod -l "app.kubernetes.io/name=prometheus" -n monitoring --timeout=120s 2>/dev/null; then
            echo "âœ… Prometheus instance is ready"
            PROMETHEUS_READY=true
          else
            echo "âš ï¸  Prometheus instance not ready yet"
            PROMETHEUS_READY=false
          fi
          echo "ready=$PROMETHEUS_READY" >> $GITHUB_OUTPUT
          
          # Check Prometheus service
          PROM_IP=$(kubectl get svc prometheus-operated -n monitoring -o jsonpath='{.spec.clusterIP}' 2>/dev/null)
          if [ -n "$PROM_IP" ]; then
            echo "âœ… Prometheus service IP: $PROM_IP:9090"
          fi

      - name: Verify Grafana Operator & Instance
        id: grafana_check
        run: |
          echo "ğŸ” Checking Grafana..."
          
          # Check Grafana operator
          if kubectl get pod -n monitoring -l "app.kubernetes.io/name=grafana-operator" -o wide; then
            echo "âœ… Grafana Operator is running"
          else
            echo "âš ï¸  Grafana Operator not found (may not be deployed yet)"
          fi
          
          # Wait for Grafana instance
          echo "â³ Waiting for Grafana instance..."
          if kubectl wait --for=condition=Ready pod -l "app.kubernetes.io/name=grafana" -n monitoring --timeout=120s 2>/dev/null; then
            echo "âœ… Grafana instance is ready"
            GRAFANA_READY=true
          else
            echo "âš ï¸  Grafana instance not ready yet"
            GRAFANA_READY=false
          fi
          echo "ready=$GRAFANA_READY" >> $GITHUB_OUTPUT
          
          # Check Grafana service
          GRAFANA_IP=$(kubectl get svc grafana-service -n monitoring -o jsonpath='{.spec.clusterIP}' 2>/dev/null)
          if [ -n "$GRAFANA_IP" ]; then
            echo "âœ… Grafana service IP: $GRAFANA_IP:3000"
          fi

      - name: Verify ServiceMonitors
        id: servicemonitor_check
        continue-on-error: true
        run: |
          echo "ğŸ” Checking ServiceMonitors..."
          
          MONITORS=("kafka-broker" "kube-state-metrics" "node-exporter")
          for monitor in "${MONITORS[@]}"; do
            if kubectl get servicemonitor $monitor -n monitoring &>/dev/null; then
              TARGET_COUNT=$(kubectl get servicemonitor $monitor -n monitoring -o jsonpath='{.spec.selector.matchLabels}' | grep -o 'app' | wc -l)
              echo "âœ… ServiceMonitor '$monitor' exists (targets configured)"
            else
              echo "âš ï¸  ServiceMonitor '$monitor' not found"
            fi
          done

      - name: Verify Grafana Datasources
        id: datasource_check
        continue-on-error: true
        run: |
          echo "ğŸ” Checking Grafana Datasources..."
          
          if kubectl get grafanadatasource prometheus -n monitoring &>/dev/null; then
            echo "âœ… GrafanaDatasource 'prometheus' configured"
            DATASOURCE_URL=$(kubectl get grafanadatasource prometheus -n monitoring -o jsonpath='{.spec.datasourceSpec.url}')
            echo "   URL: $DATASOURCE_URL"
          else
            echo "âš ï¸  GrafanaDatasource 'prometheus' not found"
          fi

      - name: Verify Grafana Dashboards
        id: dashboard_check
        continue-on-error: true
        run: |
          echo "ğŸ” Checking Grafana Dashboards..."
          
          DASHBOARDS=("kafka-broker" "k3s-cluster-health")
          for dashboard in "${DASHBOARDS[@]}"; do
            if kubectl get grafanadashboard $dashboard -n monitoring &>/dev/null; then
              UID=$(kubectl get grafanadashboard $dashboard -n monitoring -o jsonpath='{.spec.dashboard.uid}')
              TITLE=$(kubectl get grafanadashboard $dashboard -n monitoring -o jsonpath='{.spec.dashboard.title}')
              echo "âœ… Dashboard '$dashboard': $TITLE (UID: $UID)"
            else
              echo "âš ï¸  Dashboard '$dashboard' not found"
            fi
          done

      - name: Verify Kafka Metrics
        id: kafka_check
        continue-on-error: true
        run: |
          echo "ğŸ” Checking Kafka..."
          
          # Check Kafka broker pods
          KAFKA_PODS=$(kubectl get pods -n kafka -l "app.kubernetes.io/name=kafka" -o wide)
          if [ -n "$KAFKA_PODS" ]; then
            echo "âœ… Kafka brokers running:"
            echo "$KAFKA_PODS"
          else
            echo "âš ï¸  No Kafka brokers found"
          fi
          
          # Check for Kafka JMX metrics port
          if kubectl get svc -n kafka | grep -i kafka &>/dev/null; then
            echo "âœ… Kafka services exist"
          fi

      - name: Verify Prometheus Targets (if ready)
        id: prometheus_targets
        if: ${{ steps.prometheus_check.outputs.ready == 'true' }}
        continue-on-error: true
        run: |
          echo "ğŸ” Checking Prometheus targets..."
          
          # Port-forward to Prometheus
          kubectl port-forward -n monitoring svc/prometheus-operated 9090:9090 &
          sleep 3
          
          # Query targets
          TARGETS=$(curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets | length')
          if [ "$TARGETS" -gt 0 ]; then
            echo "âœ… Prometheus has $TARGETS active targets"
            curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, instance: .labels.instance}' | head -20
          else
            echo "âš ï¸  No active targets in Prometheus yet (data may be loading)"
          fi
          
          pkill -f "port-forward" || true

      - name: Verify Grafana Connectivity (if ready)
        id: grafana_connectivity
        if: ${{ steps.grafana_check.outputs.ready == 'true' }}
        continue-on-error: true
        run: |
          echo "ğŸ” Checking Grafana connectivity..."
          
          # Port-forward to Grafana
          kubectl port-forward -n monitoring svc/grafana-service 3000:80 &
          sleep 3
          
          # Check Grafana health
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health)
          if [ "$HTTP_STATUS" == "200" ]; then
            echo "âœ… Grafana API is healthy"
          else
            echo "âš ï¸  Grafana API returned status $HTTP_STATUS"
          fi
          
          # Check datasources
          DATASOURCES=$(curl -s -u admin:admin-dev-123 http://localhost:3000/api/datasources 2>/dev/null | jq 'length' || echo "0")
          if [ "$DATASOURCES" -gt 0 ]; then
            echo "âœ… Grafana has $DATASOURCES datasource(s)"
          fi
          
          pkill -f "port-forward" || true

      - name: Generate Summary Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          MONITORING STACK VERIFICATION REPORT                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š COMPONENT STATUS:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          echo ""
          echo "Kubernetes:"
          kubectl get nodes -o wide | awk '{print "  " $0}'
          
          echo ""
          echo "ArgoCD:"
          if [ "${{ steps.argocd_check.outputs.ready }}" == "true" ]; then
            echo "  âœ… ArgoCD is ready"
          else
            echo "  â³ ArgoCD is deploying"
          fi
          
          echo ""
          echo "Prometheus:"
          if [ "${{ steps.prometheus_check.outputs.ready }}" == "true" ]; then
            echo "  âœ… Prometheus is ready"
            echo "  ğŸ“ˆ Metrics endpoint: http://prometheus-operated.monitoring:9090"
          else
            echo "  â³ Prometheus is starting (wait 1-2 minutes)"
          fi
          
          echo ""
          echo "Grafana:"
          if [ "${{ steps.grafana_check.outputs.ready }}" == "true" ]; then
            echo "  âœ… Grafana is ready"
            echo "  ğŸŒ Web UI: https://grafana-dev.local:3000"
            echo "  ğŸ‘¤ User: admin"
            echo "  ğŸ”‘ Password: admin-dev-123 (from ${{ inputs.environment }} overlay)"
          else
            echo "  â³ Grafana is starting (wait 1-2 minutes)"
          fi
          
          echo ""
          echo "ServiceMonitors:"
          echo "  â€¢ kafka-broker"
          echo "  â€¢ kube-state-metrics"
          echo "  â€¢ node-exporter"
          
          echo ""
          echo "Dashboards:"
          echo "  â€¢ Kafka Broker Metrics (kafka-broker-hello)"
          echo "  â€¢ K3s Cluster Health (k3s-cluster-health)"
          
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸš€ NEXT STEPS:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          if [ "${{ steps.grafana_check.outputs.ready }}" == "true" ]; then
            echo "1. âœ… Access Grafana:"
            echo "   https://grafana-dev.local:3000"
            echo ""
            echo "2. âœ… View Dashboards:"
            echo "   - Kafka Broker Metrics"
            echo "   - K3s Cluster Health"
            echo ""
            echo "3. â³ Wait 2-3 minutes for Prometheus to collect metrics"
            echo ""
          else
            echo "1. â³ Wait for Grafana to start (1-2 minutes)"
            echo "2. â³ Rerun this action in 2-3 minutes"
            echo ""
          fi
          
          echo "ğŸ“Š For detailed status:"
          echo "   kubectl get pods -n monitoring"
          echo "   kubectl get servicemonitors -n monitoring"
          echo "   kubectl get grafanadashboards -n monitoring"
          echo ""

      - name: Fail if Critical Components Missing
        if: |
          steps.prometheus_check.outcome == 'failure' ||
          steps.grafana_check.outcome == 'failure'
        run: |
          echo "âŒ Critical monitoring components are not ready"
          echo "Please check:"
          echo "  - ArgoCD is syncing resources"
          echo "  - All pods in 'monitoring' namespace"
          echo "  - Check logs: kubectl logs -n monitoring -l app.kubernetes.io/name=grafana"
          exit 1
