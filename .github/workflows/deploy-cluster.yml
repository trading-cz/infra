name: Deploy K3s Cluster

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod

env:
  TF_VERSION: '1.13.4'

jobs:
  terraform:
    name: Deploy Cluster - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      control_plane_ip: ${{ steps.tf_outputs.outputs.control_plane_ip }}
      kafka_external_ip: ${{ steps.tf_outputs.outputs.kafka_external_ip }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Create SSH key files
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_ed25519.pub
          chmod 600 ~/.ssh/id_ed25519
          chmod 644 ~/.ssh/id_ed25519.pub
  
      - name: Terraform Init
        run: terraform init
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
      
      - name: Terraform Validate
        run: terraform validate
      
      - name: Terraform Plan
        run: |
          terraform plan \
            -var-file="environments/${{ inputs.environment }}.tfvars" \
            -var="hcloud_token=${{ secrets.HCLOUD_TOKEN }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -out=tfplan
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
      
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
      
      - name: Save Terraform outputs
        id: tf_outputs
        run: |
          echo "control_plane_ip=$(terraform output -raw control_plane_ip)" >> $GITHUB_OUTPUT
          echo "kafka_external_ip=$(terraform output -raw kafka_external_ip)" >> $GITHUB_OUTPUT
          echo "kafka_external_primary_ip_id=$(terraform output -raw kafka_external_primary_ip_id)" >> $GITHUB_OUTPUT
          echo "kafka_node_0_id=$(terraform output -raw kafka_node_0_id)" >> $GITHUB_OUTPUT
          terraform output -json > outputs.json
      
      - name: Assign Primary IP to kafka-0
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          KAFKA_NODE_0_ID="${{ steps.tf_outputs.outputs.kafka_node_0_id }}"
          PRIMARY_IP_ID="${{ steps.tf_outputs.outputs.kafka_external_primary_ip_id }}"
          KAFKA_EXTERNAL_IP="${{ steps.tf_outputs.outputs.kafka_external_ip }}"
          
          echo "=== Assigning Primary IP #2 (${KAFKA_EXTERNAL_IP}) to kafka-0 ==="
          echo "Server ID: ${KAFKA_NODE_0_ID}"
          echo "Primary IP ID: ${PRIMARY_IP_ID}"
          
          # Install hcloud CLI
          curl -fsSL https://github.com/hetznercloud/cli/releases/download/v1.47.0/hcloud-linux-amd64.tar.gz | tar -xz
          chmod +x hcloud
          
          # Power off kafka-0 (required for IP assignment)
          echo "Powering off kafka-0..."
          ./hcloud server poweroff ${KAFKA_NODE_0_ID}
          
          # Wait for power off
          echo "Waiting for shutdown..."
          sleep 10
          
          # Assign Primary IP
          echo "Assigning Primary IP..."
          ./hcloud primary-ip assign --server ${KAFKA_NODE_0_ID} ${PRIMARY_IP_ID}
          
          # Power on kafka-0
          echo "Powering on kafka-0..."
          ./hcloud server poweron ${KAFKA_NODE_0_ID}
          
          # Wait for boot
          echo "Waiting for kafka-0 to boot..."
          sleep 30
          
          echo "‚úÖ Primary IP #2 successfully assigned to kafka-0!"
          echo "   Kafka external IP: ${KAFKA_EXTERNAL_IP}"
            
      - name: Fetch kubeconfig
        run: |
          CONTROL_IP="${{ steps.tf_outputs.outputs.control_plane_ip }}"
          
          # Wait for SSH to be available
          echo "Waiting for SSH on $CONTROL_IP..."
          for i in {1..60}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i ~/.ssh/id_ed25519 root@$CONTROL_IP "echo 'SSH ready'" 2>/dev/null; then
              echo "SSH connection successful!"
              break
            fi
            echo "Attempt $i/60: SSH not ready yet, waiting..."
            sleep 10
          done
          
          # Fetch kubeconfig
          echo "Fetching kubeconfig from $CONTROL_IP..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 root@$CONTROL_IP "cat /etc/rancher/k3s/k3s.yaml" > kubeconfig-temp.yaml
          
          # Replace localhost with actual IP
          sed "s/127.0.0.1/$CONTROL_IP/g" kubeconfig-temp.yaml > kubeconfig.yaml
          
          echo "Kubeconfig fetched successfully!"
          chmod 600 kubeconfig.yaml
      
      - name: Upload kubeconfig
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig-${{ inputs.environment }}
          path: ./kubeconfig.yaml
          retention-days: 90
      
      - name: Verify cluster
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Cluster Info ==="
          kubectl cluster-info
          
          echo -e "\n=== Nodes ==="
          kubectl get nodes -o wide
          
          echo -e "\n=== System Pods ==="
          kubectl get pods -A
      
      - name: Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üéâ Cluster Access" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# Download kubeconfig from artifacts" >> $GITHUB_STEP_SUMMARY
            echo "kubectl --kubeconfig=kubeconfig.yaml get nodes" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìç Persistent Primary IPs" >> $GITHUB_STEP_SUMMARY
            echo "- Control Plane: \`${{ steps.tf_outputs.outputs.control_plane_ip }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Kafka External: \`${{ steps.tf_outputs.outputs.kafka_external_ip }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- These IPs persist after VM destruction (‚Ç¨1.00/month)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üí° To Destroy Cluster" >> $GITHUB_STEP_SUMMARY
            echo "Use **hcloud-maintenance** workflow:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Option 1 (Daily cleanup)**: \`destroy-vms\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Deletes all VMs (fast!)" >> $GITHUB_STEP_SUMMARY
            echo "  - Keeps Primary IPs for next deployment" >> $GITHUB_STEP_SUMMARY
            echo "  - Recommended for daily operations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Option 2 (Complete shutdown)**: \`destroy-all\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Deletes VMs + Primary IPs" >> $GITHUB_STEP_SUMMARY
            echo "  - Stops all billing" >> $GITHUB_STEP_SUMMARY
            echo "  - Use only when discontinuing environment" >> $GITHUB_STEP_SUMMARY
          fi

  verify-external-access:
    name: Verify External Connectivity
    needs: terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Get Terraform outputs
        id: get_outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs-${{ inputs.environment }}
          path: .
        continue-on-error: true
      
      - name: Extract IPs from terraform job
        id: ips
        run: |
          # These will be passed from the terraform job
          echo "control_plane_ip=${{ needs.terraform.outputs.control_plane_ip }}" >> $GITHUB_OUTPUT
          echo "kafka_external_ip=${{ needs.terraform.outputs.kafka_external_ip }}" >> $GITHUB_OUTPUT
      
      - name: Test Control Plane Connectivity
        run: |
          CONTROL_IP="${{ needs.terraform.outputs.control_plane_ip }}"
          
          echo "=== Testing Control Plane ($CONTROL_IP) ==="
          
          # Test SSH (port 22)
          echo -n "SSH (22): "
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$CONTROL_IP/22" 2>/dev/null; then
            echo "‚úÖ OPEN"
          else
            echo "‚ùå CLOSED"
          fi
          
          # Test Kubernetes API (port 6443)
          echo -n "K8s API (6443): "
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$CONTROL_IP/6443" 2>/dev/null; then
            echo "‚úÖ OPEN"
          else
            echo "‚ùå CLOSED"
          fi
          
          # Test HTTP (port 80)
          echo -n "HTTP (80): "
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$CONTROL_IP/80" 2>/dev/null; then
            echo "‚úÖ OPEN"
          else
            echo "‚ùå CLOSED"
          fi
          
          # Test HTTPS (port 443)
          echo -n "HTTPS (443): "
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$CONTROL_IP/443" 2>/dev/null; then
            echo "‚úÖ OPEN"
          else
            echo "‚ùå CLOSED"
          fi
      
      - name: Test Kafka External Connectivity
        run: |
          KAFKA_IP="${{ needs.terraform.outputs.kafka_external_ip }}"
          
          echo "=== Testing Kafka External Access ($KAFKA_IP) ==="
          
          # Test SSH (port 22)
          echo -n "SSH (22): "
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$KAFKA_IP/22" 2>/dev/null; then
            echo "‚úÖ OPEN"
          else
            echo "‚ùå CLOSED"
          fi
          
          # Test Kafka NodePort (port 32100)
          echo -n "Kafka NodePort (32100): "
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$KAFKA_IP/32100" 2>/dev/null; then
            echo "‚úÖ OPEN"
          else
            echo "‚ùå CLOSED - Kafka external access not available!"
          fi
          
          # Test Kafka internal ports (should be closed externally)
          echo -n "Kafka Internal (9092): "
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$KAFKA_IP/9092" 2>/dev/null; then
            echo "‚ö†Ô∏è OPEN - Should be internal only!"
          else
            echo "‚úÖ CLOSED (correct - internal only)"
          fi
      
      - name: Connectivity Summary
        if: always()
        run: |
          CONTROL_IP="${{ needs.terraform.outputs.control_plane_ip }}"
          KAFKA_IP="${{ needs.terraform.outputs.kafka_external_ip }}"
          
          echo "## üåê External Connectivity Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Control Plane: \`$CONTROL_IP\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test and report each port
          for PORT in 22 6443 80 443; do
            if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$CONTROL_IP/$PORT" 2>/dev/null; then
              echo "- ‚úÖ Port $PORT: **OPEN**" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ùå Port $PORT: **CLOSED**" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Kafka External: \`$KAFKA_IP\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Kafka port
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$KAFKA_IP/32100" 2>/dev/null; then
            echo "- ‚úÖ Port 32100 (NodePort): **OPEN** üéâ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Connect to Kafka**:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$KAFKA_IP:32100" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå Port 32100 (NodePort): **CLOSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Issue**: Kafka external access not available. Check firewall configuration." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check internal port is properly blocked
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$KAFKA_IP/9092" 2>/dev/null; then
            echo "- ‚ö†Ô∏è Port 9092 (Internal): **OPEN** - Should be blocked!" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ Port 9092 (Internal): **CLOSED** (correct)" >> $GITHUB_STEP_SUMMARY
          fi

  post-setup:
    name: Verify Cluster Bootstrap
    needs: [terraform, verify-external-access]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download kubeconfig
        uses: actions/download-artifact@v4
        with:
          name: kubeconfig-${{ inputs.environment }}
          path: .
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'
      
      - name: Wait for cloud-init to complete
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Waiting for cloud-init to install Strimzi and ArgoCD ==="
          echo "This typically takes 3-5 minutes..."
          sleep 180  # Give cloud-init time to run
          
          echo "=== Checking cluster readiness ==="
          kubectl get nodes
      
      - name: Verify Strimzi Installation
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Checking Strimzi Operator ==="
          kubectl get pods -n kafka || echo "‚ö†Ô∏è Strimzi not ready yet"
          
          # Wait for Strimzi if not ready
          kubectl wait --for=condition=ready pod -l name=strimzi-cluster-operator -n kafka --timeout=300s || true
          kubectl get pods -n kafka
      
      - name: Verify ArgoCD Installation  
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Checking ArgoCD ==="
          kubectl get pods -n argocd || echo "‚ö†Ô∏è ArgoCD not ready yet"
          
          # Wait for ArgoCD if not ready
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-application-controller -n argocd --timeout=300s || true
          kubectl get pods -n argocd
      
      - name: Verify ArgoCD Parent Application
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Checking ArgoCD Applications ==="
          kubectl get applications -n argocd -o wide
          
          echo ""
          echo "=== Parent Application Details ==="
          kubectl get application trading-system-${{ inputs.environment }} -n argocd -o yaml || echo "‚ö†Ô∏è Parent app not created yet"
      
      - name: Monitor ArgoCD Sync Progress
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "=== Waiting for ArgoCD to sync applications ==="
          sleep 60  # Give ArgoCD time to start syncing
          
          echo "=== ArgoCD Application Status ==="
          kubectl get applications -n argocd -o wide
          
          echo ""
          echo "=== All Pods Across Namespaces ==="
          kubectl get pods -A
      
      - name: Cluster Bootstrap Summary
        if: always()
        run: |
          export KUBECONFIG=./kubeconfig.yaml
          
          echo "## üéâ Cluster Bootstrap Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Installed via cloud-init (automatic)" >> $GITHUB_STEP_SUMMARY
          echo "- K3s Cluster (1 control + 3 kafka workers)" >> $GITHUB_STEP_SUMMARY
          echo "- Strimzi Operator (Kafka platform)" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD (GitOps controller)" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD Parent App (App-of-Apps pattern)" >> $GITHUB_STEP_SUMMARY
          echo "- Application namespaces (kafka, ingestion, strategies)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê External Access (Persistent IPs)" >> $GITHUB_STEP_SUMMARY
          echo "- **Control Plane**: Primary IP #1" >> $GITHUB_STEP_SUMMARY
          echo "- **Kafka-0**: Primary IP #2" >> $GITHUB_STEP_SUMMARY
          echo "- **Kafka-1, Kafka-2**: Internal only (private network)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîÑ ArgoCD GitOps Configuration" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.environment }}" == "dev" ]; then
            echo "- **Repository**: \`trading-cz/config\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch**: \`main\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Repository**: \`trading-cz/config\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch**: \`production\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Auto-sync**: ‚úÖ Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Self-heal**: ‚úÖ Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Current Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get applications -n argocd 2>/dev/null || echo "ArgoCD starting..."
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù What Happens Next" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically deploy from the **config repository**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Kafka cluster (3 brokers, KRaft mode)" >> $GITHUB_STEP_SUMMARY
          echo "2. Alpaca ingestion service" >> $GITHUB_STEP_SUMMARY
          echo "3. Dummy trading strategy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor progress:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "kubectl get applications -n argocd" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n kafka" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n ingestion" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üí∞ Cost Management" >> $GITHUB_STEP_SUMMARY
          echo "- **Primary IPs**: ‚Ç¨1.00/month (always billed)" >> $GITHUB_STEP_SUMMARY
          echo "- **VMs**: Only charged when running" >> $GITHUB_STEP_SUMMARY
          echo "- **Daily cleanup**: Use \`hcloud-maintenance ‚Üí destroy-cluster\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Complete shutdown**: Use \`hcloud-maintenance ‚Üí destroy-all\`" >> $GITHUB_STEP_SUMMARY
