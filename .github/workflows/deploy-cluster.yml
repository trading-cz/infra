name: Deploy K3s Cluster - Orchestrator

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  verify_clean:
    uses: trading-cz/infra/.github/workflows/hcloud-maintenance.yml@main
    with:
      env: ${{ inputs.environment }}
      action: 'check-clean'
    secrets:
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

  provision:
    needs: verify_clean
    uses: trading-cz/infra/.github/workflows/01-reusable-provision-infra.yml@main
    with:
      environment: ${{ inputs.environment }}
    secrets: inherit

  verify_cluster:
    needs: provision
    uses: trading-cz/infra/.github/workflows/02-reusable-verify-cluster.yml@main
    with:
      control_plane_ip: ${{ needs.provision.outputs.control_plane_ip }}
    secrets:
      ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}

  deploy_strimzi:
    needs: [provision, verify_cluster]
    if: needs.provision.result == 'success'
    uses: trading-cz/infra/.github/workflows/04-reusable-deploy-strimzi.yml@main
    with:
      control_plane_ip: ${{ needs.provision.outputs.control_plane_ip }}
    secrets:
      ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}

  deploy_argocd:
    needs: [provision, verify_cluster, deploy_strimzi]
    if: needs.provision.result == 'success'
    uses: trading-cz/infra/.github/workflows/03-reusable-deploy-argocd.yml@main
    with:
      control_plane_ip: ${{ needs.provision.outputs.control_plane_ip }}
      kafka_public_ip: ${{ needs.provision.outputs.kafka_ip }}
    secrets:
      ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
      token_git_repo_config: ${{ secrets.TOKEN_GIT_REPO_CONFIG }}

  verify_access:
    needs: [provision, deploy_argocd]
    if: needs.provision.result == 'success'
    uses: trading-cz/infra/.github/workflows/05-reusable-verify-access.yml@main
    with:
      control_plane_ip: ${{ needs.provision.outputs.control_plane_ip }}
      kafka_ip: ${{ needs.provision.outputs.kafka_ip }}
    secrets:
      ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}

  cleanup_on_failure:
    name: Auto-Cleanup on Failure
    needs: [provision, verify_cluster, deploy_argocd, deploy_strimzi, verify_access]
    if: failure()
    uses: trading-cz/infra/.github/workflows/hcloud-maintenance.yml@main
    with:
      env: ${{ inputs.environment }}
      action: 'destroy-cluster'
    secrets:
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

  summary:
    name: Deployment Summary
    needs: [provision, verify_clean, verify_cluster, deploy_argocd, deploy_strimzi, verify_access, cleanup_on_failure]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Display Summary
        run: |
          echo "========================================"
          echo "  Deployment Orchestration Summary"
          echo "========================================"
          echo "Environment: ${{ inputs.environment }}"
          echo "Control Plane IP: ${{ needs.provision.outputs.control_plane_ip }}"
          echo "ArgoCD UI: https://${{ needs.provision.outputs.control_plane_ip }}:30443"
          echo "Kafka Broker: ${{ needs.provision.outputs.kafka_ip }}:33333"
          echo "---"
          echo "Job Statuses:"
          echo "Verify Clean:    ${{ needs.verify_clean.result }}"
          echo "Provision Infra: ${{ needs.provision.result }}"
          echo "Verify Cluster:  ${{ needs.verify_cluster.result }}"
          echo "Deploy ArgoCD:   ${{ needs.deploy_argocd.result }}"
          echo "Deploy Strimzi:  ${{ needs.deploy_strimzi.result }}"
          echo "Verify Access:   ${{ needs.verify_access.result }}"
          echo "Auto Cleanup:    ${{ needs.cleanup_on_failure.result }}"
          echo "========================================"
          if [[ "${{ needs.verify_clean.result }}" != "success" || "${{ needs.provision.result }}" != "success" || "${{ needs.verify_cluster.result }}" != "success" || "${{ needs.deploy_argocd.result }}" != "success" || "${{ needs.deploy_strimzi.result }}" != "success" || "${{ needs.verify_access.result }}" != "success" ]]; then
            echo "‚ùå One or more jobs failed."
            if [[ "${{ needs.cleanup_on_failure.result }}" == "success" ]]; then
               echo "üßπ Auto-cleanup executed successfully."
            fi
            exit 1
          fi
          echo "‚úÖ All jobs completed successfully."