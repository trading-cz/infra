name: Deploy K3s Cluster - Orchestrator

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  provision:
    uses: .github/workflows/01-reusable-provision-infra.yml
    with:
      environment: ${{ inputs.environment }}
    secrets: inherit

  verify_cluster:
    needs: provision
    uses: .github/workflows/02-reusable-verify-cluster.yml
    with:
      kubeconfig: ${{ needs.provision.outputs.kubeconfig }}
      control_plane_ip: ${{ needs.provision.outputs.control_plane_ip }}

  deploy_argocd:
    needs: verify_cluster
    uses: .github/workflows/03-reusable-deploy-argocd.yml
    with:
      kubeconfig: ${{ needs.provision.outputs.kubeconfig }}
      control_plane_ip: ${{ needs.provision.outputs.control_plane_ip }}
      argocd_admin_password: ${{ secrets.ARGOCD_ADMIN_PASSWORD }}
      token_git_repo_config: ${{ secrets.TOKEN_GIT_REPO_CONFIG }}

  deploy_strimzi:
    needs: deploy_argocd
    uses: .github/workflows/04-reusable-deploy-strimzi.yml
    with:
      kubeconfig: ${{ needs.provision.outputs.kubeconfig }}

  summary:
    name: Deployment Summary
    needs: [provision, verify_cluster, deploy_argocd, deploy_strimzi]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Display Summary
        run: |
          echo "========================================"
          echo "  Deployment Orchestration Summary"
          echo "========================================"
          echo "Environment: ${{ inputs.environment }}"
          echo "Control Plane IP: ${{ needs.provision.outputs.control_plane_ip }}"
          echo "ArgoCD UI: https://${{ needs.provision.outputs.control_plane_ip }}"
          echo "---"
          echo "Job Statuses:"
          echo "Provision Infra: ${{ needs.provision.result }}"
          echo "Verify Cluster:  ${{ needs.verify_cluster.result }}"
          echo "Deploy ArgoCD:   ${{ needs.deploy_argocd.result }}"
          echo "Deploy Strimzi:  ${{ needs.deploy_strimzi.result }}"
          echo "========================================"
          if [[ "${{ needs.provision.result }}" != "success" || "${{ needs.verify_cluster.result }}" != "success" || "${{ needs.deploy_argocd.result }}" != "success" || "${{ needs.deploy_strimzi.result }}" != "success" ]]; then
            echo "❌ One or more jobs failed."
            exit 1
          fi
          echo "✅ All jobs completed successfully."