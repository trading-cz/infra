name: '04 Reusable: Deploy Strimzi'

on:
  workflow_call:
    inputs:
      control_plane_ip:
        description: 'Control Plane IP'
        required: true
        type: string
    secrets:
      ssh_private_key:
        description: 'SSH private key for server access'
        required: true

jobs:
  deploy-strimzi:
    name: Install Strimzi Operator
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ssh_private_key }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Download Kubeconfig
        run: |
          CONTROL_IP="${{ inputs.control_plane_ip }}"
          mkdir -p ~/.kube
          
          echo "üì• Downloading kubeconfig from $CONTROL_IP..."
          for i in {1..5}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@$CONTROL_IP "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config 2>/dev/null; then
              sed -i "s/127.0.0.1/$CONTROL_IP/g" ~/.kube/config
              chmod 600 ~/.kube/config
              echo "‚úÖ Kubeconfig downloaded"
              break
            fi
            echo "‚ö†Ô∏è Retry $i/5..."
            sleep 5
          done

      - name: Install Strimzi Operator
        run: |
          echo "üöÄ Creating Kafka Namespace..."
          kubectl create namespace kafka --dry-run=client -o yaml | kubectl apply -f -

          echo "üßπ Cleaning up any potential conflicting deployment..."
          # Delete the deployment if it exists to ensure a clean install/upgrade
          # This avoids the "Invalid value" error which can happen during updates or SSA
          kubectl delete deployment strimzi-cluster-operator -n kafka --ignore-not-found=true

          echo "üì¶ Installing Strimzi Operator (Latest)..."
          # Using standard Client-Side Apply (kubectl apply)
          # This is more lenient than Server-Side Apply for this specific manifest
          kubectl apply -f 'https://strimzi.io/install/latest?namespace=kafka' -n kafka --force

          echo "‚è≥ Waiting for Strimzi Cluster Operator to start..."
          # Wait for the deployment to be created before waiting for availability
          kubectl wait --for=condition=Available deployment/strimzi-cluster-operator -n kafka --timeout=300s

      - name: Verify Strimzi Installation
        run: |
          echo "‚è≥ Waiting for Strimzi Cluster Operator..."
          kubectl wait --for=condition=available deployment/strimzi-cluster-operator -n kafka --timeout=300s
          
          echo "‚úÖ Strimzi Operator is UP!"
          kubectl get pods -n kafka
          
          echo "üìú Verifying CRDs..."
          kubectl get crd | grep kafka

      - name: Debug on Failure
        if: failure()
        run: |
          echo "‚ùå Strimzi Deployment Failed. Dumping State..."
          echo "::group::Kafka Namespace Pods"
          kubectl get pods -n kafka -o wide
          echo "::endgroup::"
          echo "::group::Kafka Namespace Events"
          kubectl get events -n kafka --sort-by='.lastTimestamp'
          echo "::endgroup::"
          echo "::group::Strimzi Operator Logs"
          kubectl logs -n kafka -l name=strimzi-cluster-operator --tail=100 || true
          echo "::endgroup::"
          echo "::group::Describe Pod"
          kubectl describe pod -n kafka -l name=strimzi-cluster-operator
          echo "::endgroup::"
