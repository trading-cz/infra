name: 'Reusable: Deploy Strimzi'

on:
  workflow_call:
    inputs:
      control_plane_ip:
        description: 'Control Plane IP'
        required: true
        type: string
    secrets:
      ssh_private_key:
        description: 'SSH private key for server access'
        required: true

jobs:
  deploy:
    name: Deploy and Verify Strimzi
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ssh_private_key }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Download Kubeconfig from Control Plane
        run: |
          CONTROL_IP="${{ inputs.control_plane_ip }}"
          mkdir -p ~/.kube
          
          echo "üì• Downloading kubeconfig from $CONTROL_IP..."
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@$CONTROL_IP "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config 2>/dev/null; then
            sed -i "s/127.0.0.1/$CONTROL_IP/g" ~/.kube/config
            chmod 600 ~/.kube/config
            echo "‚úÖ Kubeconfig downloaded and configured"
          else
            echo "‚ùå Failed to download kubeconfig"
            exit 1
          fi

      - name: Verify Strimzi Kafka Operator
        run: |
          if kubectl get namespace kafka 2>/dev/null; then
            echo "‚úÖ Kafka namespace exists"
          else
            echo "‚ùå Kafka namespace not found. It should be created by ArgoCD."
            exit 1
          fi
          
          echo "Waiting for Strimzi operator to be ready..."
          if ! kubectl wait --for=condition=available deployment/strimzi-cluster-operator -n kafka --timeout=300s; then
            echo "‚ùå Strimzi operator not ready after 5 minutes"
            kubectl logs -n kafka deployment/strimzi-cluster-operator --tail=50
            exit 1
          fi
          echo "‚úÖ Strimzi operator is running"

      - name: Verify Strimzi Kafka CRDs
        run: |
          REQUIRED_CRDS=(
            "kafkas.kafka.strimzi.io"
            "kafkatopics.kafka.strimzi.io"
            "kafkausers.kafka.strimzi.io"
          )
          ALL_CRDS_PRESENT=true
          for CRD in "${REQUIRED_CRDS[@]}"; do
            if kubectl get crd "$CRD" 2>/dev/null; then
              echo "‚úÖ CRD exists: $CRD"
            else
              echo "‚ùå CRD missing: $CRD"
              ALL_CRDS_PRESENT=false
            fi
          done
          if [ "$ALL_CRDS_PRESENT" = "false" ]; then
            echo "‚ùå Some Strimzi CRDs are missing"
            exit 1
          fi
          echo "‚úÖ All required Strimzi CRDs are installed"
