name: 'Reusable: Verify K3s Cluster'

on:
  workflow_call:
    inputs:
      kubeconfig:
        description: 'Kubeconfig file content'
        required: true
        type: string
      control_plane_ip:
        description: 'Control Plane IP'
        required: true
        type: string

jobs:
  verify:
    name: Verify K3s cluster
    runs-on: ubuntu-latest
    steps:
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ inputs.kubeconfig }}" > ~/.kube/config

      - name: Verify K3s Nodes
        run: |
          kubectl get nodes
          NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
          if [ "$NODE_COUNT" -ge 2 ]; then
            echo "✅ K3s cluster operational with $NODE_COUNT nodes"
          else
            echo "❌ Expected at least 2 nodes, found $NODE_COUNT"
            exit 1
          fi

      - name: Verify System Pods
        run: |
          echo "Waiting for CoreDNS to be ready..."
          kubectl wait --for=condition=ready pod -l k8s-app=kube-dns -n kube-system --timeout=300s
          COREDNS_COUNT=$(kubectl get pods -n kube-system -l k8s-app=kube-dns --no-headers | grep Running | wc -l)
          if [ "$COREDNS_COUNT" -ge 1 ]; then
            echo "✅ CoreDNS running ($COREDNS_COUNT pods)"
          else
            echo "❌ CoreDNS not running"
            exit 1
          fi

      - name: Verify Traefik Ingress Controller
        run: |
          echo "Checking Traefik ingress controller..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=traefik -n kube-system --timeout=300s || true
          TRAEFIK_COUNT=$(kubectl get pods -n kube-system -l app.kubernetes.io/name=traefik --no-headers | grep Running | wc -l)
          if [ "$TRAEFIK_COUNT" -ge 1 ]; then
            echo "✅ Traefik ingress controller running ($TRAEFIK_COUNT pods)"
          else
            echo "⚠️  Traefik not running - ingress may not work"
          fi
          
          echo ""
          echo "Traefik service:"
          kubectl get svc -n kube-system -l app.kubernetes.io/name=traefik || true

      - name: Verify Strimzi Operator
        run: |
          echo "Checking Strimzi Kafka Operator..."
          kubectl wait --for=condition=ready pod -l name=strimzi-cluster-operator -n kafka --timeout=300s || true
          STRIMZI_COUNT=$(kubectl get pods -n kafka -l name=strimzi-cluster-operator --no-headers | grep Running | wc -l)
          if [ "$STRIMZI_COUNT" -ge 1 ]; then
            echo "✅ Strimzi operator running ($STRIMZI_COUNT pods)"
          else
            echo "⚠️  Strimzi operator not running"
          fi
          
          echo ""
          echo "Strimzi CRDs:"
          kubectl get crd | grep kafka.strimzi.io || echo "⚠️  No Strimzi CRDs found"
          
      - name: Verify Network Ports
        run: |
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/${{ inputs.control_plane_ip }}/6443" 2>/dev/null; then
            echo "✅ K3s API port 6443 is open"
          else
            echo "❌ K3s API port 6443 is not accessible"
            exit 1
          fi

      - name: Label Kafka Nodes
        run: |
          echo "Labeling Kafka nodes for workload placement..."
          for node in $(kubectl get nodes -o name | grep kafka); do
            NODE_NAME=$(echo $node | cut -d'/' -f2)
            kubectl label node "$NODE_NAME" workload=kafka --overwrite
            echo "✅ Labeled $NODE_NAME with workload=kafka"
          done
          echo ""
          echo "Node labels:"
          kubectl get nodes --show-labels
