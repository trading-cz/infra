name: 'Reusable: Deploy ArgoCD'

on:
  workflow_call:
    inputs:
      kubeconfig:
        description: 'Kubeconfig file content'
        required: true
        type: string
      control_plane_ip:
        description: 'Control Plane IP'
        required: true
        type: string
      environment:
        description: 'Deployment environment (dev|prod)'
        required: true
        type: string
    secrets:
      argocd_admin_password:
        description: 'ArgoCD admin password'
        required: false
      token_git_repo_config:
        description: 'Token for config repo'
        required: true

jobs:
  deploy:
    name: Deploy and Verify ArgoCD
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra Repository
        uses: actions/checkout@v4
        with:
          path: infra

      - name: Checkout Config Repository
        uses: actions/checkout@v4
        with:
          repository: trading-cz/config
          ref: main
          path: config
          token: ${{ secrets.token_git_repo_config }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ inputs.kubeconfig }}" > ~/.kube/config

      - name: Install Helm
        run: |
          echo "Installing Helm..."
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Install ArgoCD via Helm
        run: |
          echo "=========================================="
          echo "Installing ArgoCD via Helm"
          echo "Method: Helm chart from official repository"
          echo "=========================================="
          
          # Create namespace
          kubectl create namespace argocd || echo "Namespace argocd already exists"
          
          # Add ArgoCD Helm repository
          echo "Adding ArgoCD Helm repository..."
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo update
          
          # Install ArgoCD
          echo "Installing ArgoCD..."
          helm install argocd argo/argo-cd \
            --namespace argocd \
            --version 7.7.9 \
            --set server.service.type=NodePort \
            --set server.service.nodePortHttp=80 \
            --wait --timeout 10m
          
          echo ""
          echo "Verifying ArgoCD installation..."
          kubectl get pods -n argocd
          kubectl get svc -n argocd
          
          echo ""
          echo "Waiting for ArgoCD server to be ready..."
          kubectl wait --for=condition=available --timeout=5m \
            deployment/argocd-server -n argocd || {
              echo "ERROR: ArgoCD server deployment failed to become ready"
              echo "Deployment status:"
              kubectl get deployment -n argocd
              echo ""
              echo "Pod status:"
              kubectl get pods -n argocd
              echo ""
              echo "Pod logs:"
              kubectl logs -n argocd -l app.kubernetes.io/name=argocd-server --tail=50
              exit 1
            }
          
          echo ""
          echo "=========================================="
          echo "ArgoCD installed successfully via Helm!"
          echo "=========================================="

      - name: Configure ArgoCD
        run: |
          echo "Checking ArgoCD components status..."
          kubectl get pods -n argocd
          
          # Apply any custom configuration from config repository if it exists
          if [ -d "config/base/operators/argocd" ]; then
            echo "Applying custom ArgoCD configuration from config repository..."
            # Filter out ArgoCD CR files as we're using Helm
            find config/base/operators/argocd -name "*.yaml" -o -name "*.yml" | while read -r file; do
              # Skip files that contain 'kind: ArgoCD' as they're operator-specific
              if ! grep -q "kind: ArgoCD" "$file" 2>/dev/null; then
                kubectl apply -f "$file" || echo "Skipping $file"
              fi
            done
          else
            echo "No custom configuration found in config repository"
          fi
          
          echo "Waiting for ArgoCD components to be ready..."
          kubectl wait --for=condition=available --timeout=5m \
            deployment/argocd-server -n argocd || true
          kubectl wait --for=condition=available --timeout=5m \
            deployment/argocd-repo-server -n argocd || true
          kubectl wait --for=condition=available --timeout=5m \
            deployment/argocd-redis -n argocd || true

      - name: Configure ArgoCD Admin Password
        if: inputs.environment == 'prod' || github.event.inputs.argocd_admin_password != ''
        env:
          ADMIN_PASSWORD: ${{ secrets.argocd_admin_password }}
        run: |
          if [ -n "$ADMIN_PASSWORD" ]; then
            echo "Setting custom admin password..."
            # Hash the password using bcrypt
            BCRYPT_PASSWORD=$(htpasswd -nbBC 10 "" "$ADMIN_PASSWORD" | tr -d ':\n' | sed 's/$2y/$2a/')
            MTIME=$(date +%FT%T%Z)
            kubectl -n argocd patch secret argocd-secret \
              -p "{\"stringData\": {\"admin.password\": \"$BCRYPT_PASSWORD\", \"admin.passwordMtime\": \"$MTIME\"}}"
            echo "Admin password updated successfully"
          fi

      - name: Get Initial Admin Password
        run: |
          echo "Fetching admin password..."
          # Wait a moment for the secret to be created
          sleep 5
          ADMIN_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret \
            -o jsonpath='{.data.password}' 2>/dev/null | base64 -d || echo "")
          
          if [ -z "$ADMIN_PASSWORD" ]; then
            echo "Initial admin secret not found, checking argocd-secret..."
            ADMIN_PASSWORD=$(kubectl -n argocd get secret argocd-secret \
              -o jsonpath='{.data.admin\.password}' 2>/dev/null | base64 -d || echo "admin")
          fi
          
          echo "::add-mask::$ADMIN_PASSWORD"
          echo ""
          echo "=========================================="
          echo "ArgoCD Admin Credentials:"
          echo "Username: admin"
          echo "Password: $ADMIN_PASSWORD"
          echo "=========================================="

      - name: Verify ArgoCD Installation
        run: |
          echo "========================================"
          echo "  ArgoCD Installation Summary"
          echo "========================================"
          echo "Namespace: argocd"
          echo "ArgoCD UI: http://${{ inputs.control_plane_ip }}"
          echo "Username: admin"
          echo ""
          echo "Pods:"
          kubectl get pods -n argocd
          echo ""
          echo "Services:"
          kubectl get svc -n argocd
          echo "========================================"

