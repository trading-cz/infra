name: 'Reusable: Deploy ArgoCD'

on:
  workflow_call:
    inputs:
      kubeconfig:
        description: 'Kubeconfig file content'
        required: true
        type: string
      control_plane_ip:
        description: 'Control Plane IP'
        required: true
        type: string
      environment:
        description: 'Deployment environment (dev|prod)'
        required: true
        type: string
    secrets:
      argocd_admin_password:
        description: 'ArgoCD admin password'
        required: false
      token_git_repo_config:
        description: 'Token for config repo'
        required: true

jobs:
  deploy:
    name: Deploy and Verify ArgoCD
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra Repository
        uses: actions/checkout@v4
        with:
          path: infra

      - name: Checkout Config Repository
        uses: actions/checkout@v4
        with:
          repository: trading-cz/config
          ref: main
          path: config
          token: ${{ secrets.token_git_repo_config }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ inputs.kubeconfig }}" > ~/.kube/config

      - name: Wait for Argo CD operator readiness
        run: |
          if ! kubectl wait --for=condition=Available deployment/argocd-operator-controller-manager -n argocd --timeout=600s; then
            echo "❌ Argo CD operator not ready"
            kubectl get pods -n argocd || true
            exit 1
          fi

      - name: Apply Argo CD custom resource
        working-directory: config
        run: |
          OVERLAY_PATH="overlays/${{ inputs.environment }}/operators/argocd"
          if [ ! -d "$OVERLAY_PATH" ]; then
            echo "❌ Overlay path $OVERLAY_PATH not found"
            ls overlays/*/operators || true
            exit 1
          fi
          kubectl apply -k "$OVERLAY_PATH"

      - name: Wait for Argo CD control plane
        run: |
          set -e
          COMPONENTS=(application-controller repo-server server)
          for component in "${COMPONENTS[@]}"; do
            kubectl rollout status deployment/trading-argocd-${component} -n argocd --timeout=600s
          done
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/part-of=argocd -n argocd --timeout=600s

      - name: Bootstrap ArgoCD - Connect to config repository
        working-directory: config
        continue-on-error: true
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: trading-config-repo
            namespace: argocd
            labels:
              argocd.argoproj.io/secret-type: repository
          type: Opaque
          stringData:
            type: git
            url: https://github.com/trading-cz/config.git
            password: ${{ secrets.token_git_repo_config }}
            username: not-used
          EOF
          
          kubectl apply -f app-of-apps/argocd/parent-app.yaml

      - name: Apply ArgoCD ingress
        run: |
          kubectl apply -f infra/modules/argocd-bootstrap/argocd-ingress.yaml
          
          if [ -n "${{ secrets.argocd_admin_password }}" ]; then
            python3 -m pip install bcrypt --quiet
            BCRYPT_HASH=$(python3 -c "import bcrypt; print(bcrypt.hashpw('${{ secrets.argocd_admin_password }}'.encode('utf-8'), bcrypt.gensalt(rounds=10)).decode('utf-8'))")
            kubectl delete secret argocd-initial-admin-secret -n argocd 2>/dev/null || true
            kubectl patch secret argocd-secret -n argocd --type merge \
              -p "{\"stringData\": {\"admin.password\": \"$BCRYPT_HASH\", \"admin.passwordMtime\": \"$(date +%FT%T%Z)\"}}"
          fi
          
      - name: Verify ArgoCD Operation
        run: |
          echo "Waiting for applications to be detected..."
          sleep 15
          kubectl get applications -n argocd
