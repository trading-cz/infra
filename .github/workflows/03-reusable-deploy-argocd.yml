name: 'Reusable: Deploy ArgoCD'

on:
  workflow_call:
    inputs:
      control_plane_ip:
        description: 'Control Plane IP'
        required: true
        type: string
      environment:
        description: 'Deployment environment (dev|prod)'
        required: true
        type: string
    secrets:
      ssh_private_key:
        description: 'SSH private key for server access'
        required: true
      argocd_admin_password:
        description: 'ArgoCD admin password'
        required: false
      token_git_repo_config:
        description: 'Token for config repo'
        required: true

jobs:
  deploy:
    name: Deploy and Verify ArgoCD
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra Repository
        uses: actions/checkout@v4
        with:
          path: infra

      - name: Checkout Config Repository
        uses: actions/checkout@v4
        with:
          repository: trading-cz/config
          ref: main
          path: config
          token: ${{ secrets.token_git_repo_config }}

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ssh_private_key }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "âœ… SSH key configured"

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          echo "âœ… kubectl installed"

      - name: Download Kubeconfig from Control Plane
        run: |
          CONTROL_IP="${{ inputs.control_plane_ip }}"
          
          echo "=========================================="
          echo "Downloading Kubeconfig from Control Plane"
          echo "Control Plane IP: $CONTROL_IP"
          echo "=========================================="
          
          mkdir -p ~/.kube
          
          echo "ðŸ“¥ Fetching kubeconfig via SSH..."
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@$CONTROL_IP "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config 2>/dev/null; then
            echo "âœ… Kubeconfig downloaded successfully"
          else
            echo "âŒ Failed to download kubeconfig from control plane"
            echo "   Verify:"
            echo "   1. Control plane IP is correct: $CONTROL_IP"
            echo "   2. SSH access is working: ssh root@$CONTROL_IP"
            echo "   3. K3s is installed: /etc/rancher/k3s/k3s.yaml exists"
            exit 1
          fi
          
          # Replace localhost with actual control plane IP
          sed -i "s/127.0.0.1/$CONTROL_IP/g" ~/.kube/config
          chmod 600 ~/.kube/config
          
          FILE_SIZE=$(stat -c%s ~/.kube/config)
          echo "âœ… Kubeconfig prepared (size: $FILE_SIZE bytes)"
          
          echo ""
          echo "Testing cluster connection..."
          if kubectl cluster-info > /tmp/cluster_info.log 2>&1; then
            echo "âœ… Cluster connection successful!"
            cat /tmp/cluster_info.log
          else
            echo "âŒ Cannot connect to cluster"
            cat /tmp/cluster_info.log
            echo ""
            echo "Kubeconfig content (first 10 lines):"
            head -n 10 ~/.kube/config
            exit 1
          fi
          
          echo ""
          echo "=========================================="

      - name: Install ArgoCD Operator
        env:
          KUBECONFIG: /home/runner/.kube/config
        run: |
          echo "=========================================="
          echo "Installing ArgoCD Operator v0.15.0"
          echo "Method: kubectl apply (manual installation)"
          echo "=========================================="
          
          # Verify kubectl can connect
          echo "Verifying cluster connectivity..."
          kubectl get nodes || {
            echo "ERROR: Cannot connect to Kubernetes cluster"
            echo "KUBECONFIG: $KUBECONFIG"
            exit 1
          }
          
          echo ""
          echo "Current cluster state:"
          echo "Namespaces:"
          kubectl get namespaces
          echo ""
          echo "Existing ArgoCD resources:"
          kubectl get all -n argocd 2>/dev/null || echo "No resources in argocd namespace"
          kubectl get all -n argocd-operator-system 2>/dev/null || echo "No resources in argocd-operator-system namespace"
          echo ""
          
          # Download and extract the operator release
          OPERATOR_VERSION="v0.15.0"
          echo "Downloading ArgoCD Operator ${OPERATOR_VERSION}..."
          curl -sL "https://github.com/argoproj-labs/argocd-operator/archive/refs/tags/${OPERATOR_VERSION}.tar.gz" -o argocd-operator.tar.gz
          
          echo "Extracting archive..."
          tar -xzf argocd-operator.tar.gz
          
          echo ""
          echo "Deploying operator using kustomize..."
          kubectl create namespace argocd 2>/dev/null || echo "Namespace argocd already exists"
          kubectl create namespace argocd-operator-system 2>/dev/null || echo "Namespace argocd-operator-system already exists"
          
          kubectl apply -k argocd-operator-${OPERATOR_VERSION#v}/config/default
          
          echo ""
          echo "Waiting for operator to be ready..."
          kubectl wait --for=condition=available --timeout=5m \
            deployment/argocd-operator-controller-manager \
            -n argocd-operator-system || {
              echo "ERROR: Operator deployment failed to become ready"
              echo "Deployment status:"
              kubectl get deployment -n argocd-operator-system
              echo ""
              echo "Pod status:"
              kubectl get pods -n argocd-operator-system
              echo ""
              echo "Pod logs:"
              kubectl logs -n argocd-operator-system -l control-plane=controller-manager --tail=50
              exit 1
            }
          
          echo ""
          echo "Verifying operator installation..."
          kubectl get pods -n argocd-operator-system
          
          echo ""
          echo "Checking ArgoCD CRDs..."
          kubectl get crd | grep argoproj || {
            echo "WARNING: ArgoCD CRDs not found"
            kubectl get crd
            exit 1
          }
          
          echo ""
          echo "=========================================="
          echo "ArgoCD Operator installed successfully!"
          echo "=========================================="

      - name: Deploy ArgoCD Instance
        run: |
          echo "Deploying ArgoCD CR from config repository..."
          kubectl apply -k config/base/operators/argocd
          
          echo "Waiting for ArgoCD components to be ready..."
          kubectl wait --for=condition=available --timeout=5m \
            deployment/trading-argocd-server -n argocd || true
          kubectl wait --for=condition=available --timeout=5m \
            deployment/trading-argocd-repo-server -n argocd || true
          kubectl wait --for=condition=available --timeout=5m \
            deployment/trading-argocd-redis -n argocd || true

      - name: Configure ArgoCD Admin Password
        if: inputs.environment == 'prod' || github.event.inputs.argocd_admin_password != ''
        env:
          ADMIN_PASSWORD: ${{ secrets.argocd_admin_password }}
        run: |
          if [ -n "$ADMIN_PASSWORD" ]; then
            echo "Setting custom admin password..."
            kubectl -n argocd patch secret trading-argocd-cluster \
              -p "{\"stringData\": {\"admin.password\": \"$ADMIN_PASSWORD\"}}"
            echo "Admin password updated successfully"
          fi

      - name: Get Initial Admin Password
        run: |
          echo "Fetching admin password..."
          ADMIN_PASSWORD=$(kubectl -n argocd get secret trading-argocd-cluster \
            -o jsonpath='{.data.admin\.password}' | base64 -d)
          echo "::add-mask::$ADMIN_PASSWORD"
          echo ""
          echo "=========================================="
          echo "ArgoCD Admin Credentials:"
          echo "Username: admin"
          echo "Password: $ADMIN_PASSWORD"
          echo "=========================================="

      - name: Verify ArgoCD Installation
        run: |
          echo "========================================"
          echo "  ArgoCD Installation Summary"
          echo "========================================"
          echo "Namespace: argocd"
          echo "ArgoCD UI: http://${{ inputs.control_plane_ip }}"
          echo "Username: admin"
          echo ""
          echo "Pods:"
          kubectl get pods -n argocd
          echo ""
          echo "Services:"
          kubectl get svc -n argocd
          echo "========================================"

