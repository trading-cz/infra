name: 'Reusable: Deploy ArgoCD'

on:
  workflow_call:
    inputs:
      kubeconfig:
        description: 'Kubeconfig file content'
        required: true
        type: string
      control_plane_ip:
        description: 'Control Plane IP'
        required: true
        type: string
      environment:
        description: 'Deployment environment (dev|prod)'
        required: true
        type: string
    secrets:
      argocd_admin_password:
        description: 'ArgoCD admin password'
        required: false
      token_git_repo_config:
        description: 'Token for config repo'
        required: true

jobs:
  deploy:
    name: Deploy and Verify ArgoCD
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra Repository
        uses: actions/checkout@v4
        with:
          path: infra

      - name: Checkout Config Repository
        uses: actions/checkout@v4
        with:
          repository: trading-cz/config
          ref: main
          path: config
          token: ${{ secrets.token_git_repo_config }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ inputs.kubeconfig }}" > ~/.kube/config