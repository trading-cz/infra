name: '01 Reusable: Provision Infrastructure'

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: string
    outputs:
      control_plane_ip:
        description: "Control Plane IP"
        value: ${{ jobs.provision.outputs.control_plane_ip }}
      kafka_ip:
        description: "Kafka Node IP"
        value: ${{ jobs.provision.outputs.kafka_ip }}

env:
  TF_VERSION: '1.13.4'

jobs:
  provision:
    name: Provision ${{ inputs.environment }} infrastructure
    runs-on: ubuntu-latest
    outputs:
      control_plane_ip: ${{ steps.tf_output.outputs.control_ip }}
      kafka_ip: ${{ steps.tf_output.outputs.kafka_ip }}

    steps:
      - name: Checkout Infra Repository
        uses: actions/checkout@v4
        with:
          path: infra

      - name: Setup Terraform ${{ env.TF_VERSION }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Install hcloud CLI
        run: |
          curl -fsSL https://github.com/hetznercloud/cli/releases/download/v1.47.0/hcloud-linux-amd64.tar.gz | tar -xz
          chmod +x hcloud
          sudo mv hcloud /usr/local/bin/
          hcloud version

      - name: Setup SSH keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_ed25519.pub
          chmod 600 ~/.ssh/id_ed25519
          chmod 644 ~/.ssh/id_ed25519.pub

      - name: Create or Get Primary IPs
        id: primary_ips
        run: |
          export HCLOUD_TOKEN="${{ secrets.HCLOUD_TOKEN }}"
          ENV="${{ inputs.environment }}"
          CLUSTER="k3s-trading"
          CONTROL_IP_NAME="${ENV}-${CLUSTER}-control-ip"
          CONTROL_IP_ID=$(hcloud primary-ip list -o noheader -o columns=id,name | grep "$CONTROL_IP_NAME" | awk '{print $1}')
          if [ -z "$CONTROL_IP_ID" ]; then
            CONTROL_IP_ID=$(hcloud primary-ip create --type ipv4 --name "$CONTROL_IP_NAME" --datacenter nbg1-dc3 --label environment=$ENV --label cluster=$CLUSTER --label role=control-plane -o json | jq -r '.primary_ip.id')
          fi
          echo "control_plane_primary_ip_id=$CONTROL_IP_ID" >> $GITHUB_OUTPUT
          
          KAFKA_IP_NAME="${ENV}-${CLUSTER}-kafka-ip"
          KAFKA_IP_ID=$(hcloud primary-ip list -o noheader -o columns=id,name | grep "$KAFKA_IP_NAME" | awk '{print $1}')
          if [ -z "$KAFKA_IP_ID" ]; then
            KAFKA_IP_ID=$(hcloud primary-ip create --type ipv4 --name "$KAFKA_IP_NAME" --datacenter nbg1-dc3 --label environment=$ENV --label cluster=$CLUSTER --label role=kafka -o json | jq -r '.primary_ip.id')
          fi
          echo "kafka_primary_ip_id=$KAFKA_IP_ID" >> $GITHUB_OUTPUT

      - name: Terraform Init
        working-directory: infra
        run: terraform init

      - name: Terraform Apply
        working-directory: infra
        run: terraform apply -auto-approve -var-file="environments/${{ inputs.environment }}.tfvars"
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_control_plane_primary_ip_id: ${{ steps.primary_ips.outputs.control_plane_primary_ip_id }}
          TF_VAR_kafka_primary_ip_id: ${{ steps.primary_ips.outputs.kafka_primary_ip_id }}

      - name: Extract Terraform Outputs
        id: tf_output
        working-directory: infra
        run: |
          CONTROL_IP=$(terraform output -raw k3s_control_public_ip)
          # kafka-0 is the only node with public IP (for external access)
          KAFKA_IP=$(terraform output -json kafka_server_public_ips | jq -r '.[0]')
          # Get all private IPs for internal token distribution
          KAFKA_PRIVATE_IPS=$(terraform output -json kafka_server_private_ips | jq -c '.')
          KAFKA_COUNT=$(terraform output -json kafka_server_private_ips | jq -r '. | length')
          echo "control_ip=$CONTROL_IP" >> $GITHUB_OUTPUT
          echo "kafka_ip=$KAFKA_IP" >> $GITHUB_OUTPUT
          echo "kafka_private_ips=$KAFKA_PRIVATE_IPS" >> $GITHUB_OUTPUT
          echo "kafka_count=$KAFKA_COUNT" >> $GITHUB_OUTPUT

      - name: Verify SSH and Cloud-init
        run: |
          CONTROL_IP=${{ steps.tf_output.outputs.control_ip }}
          KAFKA_IP=${{ steps.tf_output.outputs.kafka_ip }}
          KAFKA_COUNT=${{ steps.tf_output.outputs.kafka_count }}
          
          echo "=========================================="
          echo "Step 1: Waiting for SSH on Control Plane ($CONTROL_IP)"
          echo "=========================================="
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "echo 'SSH ready'" 2>/dev/null; then
              echo "‚úÖ SSH accessible on control plane (attempt $i)"
              break
            fi
            echo "‚è≥ Attempt $i/30 failed, retrying in 10s..."
            sleep 10
            if [ $i -eq 30 ]; then
              echo "‚ùå SSH not accessible on control plane after 5 minutes"
              exit 1
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "Step 2: Waiting for SSH on Kafka-0 ($KAFKA_IP)"
          echo "=========================================="
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "echo 'SSH ready'" 2>/dev/null; then
              echo "‚úÖ SSH accessible on kafka-0 (attempt $i)"
              break
            fi
            echo "‚è≥ Attempt $i/30 failed, retrying in 10s..."
            sleep 10
            if [ $i -eq 30 ]; then
              echo "‚ùå SSH not accessible on kafka-0 after 5 minutes"
              exit 1
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "Step 3: Waiting for K3s Control Plane Installation"
          echo "Checking for: /root/k3s-ready.txt"
          echo "=========================================="
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "test -f /root/k3s-ready.txt" 2>/dev/null; then
              echo "‚úÖ K3s control plane ready (attempt $i)"
              echo ""
              echo "Cloud-init log (last 30 lines):"
              ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "tail -30 /var/log/cloud-init-output.log" || true
              break
            fi
            echo "‚è≥ Attempt $i/30 - K3s not ready yet, retrying in 5s..."
            if [ $i -eq 30 ]; then
              echo "‚ùå K3s control plane not ready after 5 minutes"
              echo ""
              echo "üìã Debugging Information:"
              echo "Cloud-init status:"
              ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "cloud-init status" || true
              echo ""
              echo "Cloud-init output (last 50 lines):"
              ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "tail -50 /var/log/cloud-init-output.log" || true
              echo ""
              echo "Files in /root:"
              ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "ls -la /root/" || true
              exit 1
            fi
            sleep 5
          done
          
          echo ""
          echo "=========================================="
          echo "Step 4: Retrieving K3s Token"
          echo "=========================================="
          K3S_TOKEN=$(ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "cat /var/lib/rancher/k3s/server/node-token" 2>/dev/null)
          if [ -z "$K3S_TOKEN" ]; then
            echo "‚ùå Failed to retrieve K3s token"
            echo "Token file contents:"
            ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "ls -la /var/lib/rancher/k3s/server/" || true
            exit 1
          fi
          echo "‚úÖ K3s token retrieved (length: ${#K3S_TOKEN})"
          
          echo ""
          echo "=========================================="
          echo "Step 5: Distributing K3s Token to Kafka-0 (Public IP)"
          echo "=========================================="
          if ssh -o StrictHostKeyChecking=no root@$KAFKA_IP "echo '$K3S_TOKEN' > /tmp/k3s-token && chmod 600 /tmp/k3s-token"; then
            echo "‚úÖ Token distributed to kafka-0"
          else
            echo "‚ùå Failed to distribute token to kafka-0"
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "Step 6: Waiting for Kafka-0 to Join Cluster"
          echo "Checking for: /root/k3s-agent-ready.txt"
          echo "=========================================="
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no root@$KAFKA_IP "test -f /root/k3s-agent-ready.txt" 2>/dev/null; then
              echo "‚úÖ Kafka-0 joined cluster (attempt $i)"
              echo ""
              echo "Cloud-init log (last 30 lines):"
              ssh -o StrictHostKeyChecking=no root@$KAFKA_IP "tail -30 /var/log/cloud-init-output.log" || true
              break
            fi
            echo "‚è≥ Attempt $i/30 - Agent not ready yet, retrying in 5s..."
            if [ $i -eq 30 ]; then
              echo "‚ùå Kafka-0 agent not ready after 5 minutes"
              echo ""
              echo "üìã Debugging Information:"
              echo "Cloud-init status:"
              ssh -o StrictHostKeyChecking=no root@$KAFKA_IP "cloud-init status" || true
              echo ""
              echo "Cloud-init output (last 50 lines):"
              ssh -o StrictHostKeyChecking=no root@$KAFKA_IP "tail -50 /var/log/cloud-init-output.log" || true
              echo ""
              echo "Files in /root:"
              ssh -o StrictHostKeyChecking=no root@$KAFKA_IP "ls -la /root/" || true
              echo ""
              echo "Token file check:"
              ssh -o StrictHostKeyChecking=no root@$KAFKA_IP "ls -la /tmp/k3s-token" || true
              exit 1
            fi
            sleep 5
          done
          
          echo ""
          echo "=========================================="
          echo "Step 7: Distributing Token to Additional Kafka Nodes via Jump Host"
          echo "=========================================="
          # kafka-1, kafka-2, etc. have no public IP - access via control plane
          KAFKA_PRIVATE_IPS='${{ steps.tf_output.outputs.kafka_private_ips }}'
          TOTAL_KAFKA=$KAFKA_COUNT
          
          if [ "$TOTAL_KAFKA" -gt 1 ]; then
            echo "Total Kafka nodes: $TOTAL_KAFKA (kafka-0 already done, processing kafka-1 through kafka-$((TOTAL_KAFKA-1)))"
            
            # Copy SSH key to control plane for jump host access
            echo "Setting up SSH key on control plane for internal access..."
            scp -o StrictHostKeyChecking=no ~/.ssh/id_ed25519 root@$CONTROL_IP:/root/.ssh/id_ed25519
            ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "chmod 600 /root/.ssh/id_ed25519"
            
            # Process each additional kafka node (skip index 0)
            for idx in $(seq 1 $((TOTAL_KAFKA-1))); do
              PRIVATE_IP=$(echo "$KAFKA_PRIVATE_IPS" | jq -r ".[$idx]")
              echo ""
              echo "--- Processing kafka-$idx ($PRIVATE_IP) ---"
              
              echo "Waiting for SSH on kafka-$idx (via control plane)..."
              for j in {1..30}; do
                if ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$PRIVATE_IP 'echo SSH ready'" 2>/dev/null; then
                  echo "‚úÖ SSH accessible on kafka-$idx (attempt $j)"
                  break
                fi
                echo "‚è≥ Attempt $j/30..."
                sleep 10
                if [ $j -eq 30 ]; then
                  echo "‚ùå Cannot reach kafka-$idx via jump host after 5 minutes"
                  exit 1
                fi
              done
              
              echo "Distributing token to kafka-$idx..."
              if ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "ssh -o StrictHostKeyChecking=no root@$PRIVATE_IP \"echo '$K3S_TOKEN' > /tmp/k3s-token && chmod 600 /tmp/k3s-token\""; then
                echo "‚úÖ Token distributed to kafka-$idx"
              else
                echo "‚ùå Failed to distribute token to kafka-$idx"
                exit 1
              fi
              
              echo "Waiting for kafka-$idx to join cluster..."
              for j in {1..30}; do
                if ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "ssh -o StrictHostKeyChecking=no root@$PRIVATE_IP 'test -f /root/k3s-agent-ready.txt'" 2>/dev/null; then
                  echo "‚úÖ kafka-$idx joined cluster (attempt $j)"
                  break
                fi
                echo "‚è≥ Attempt $j/30..."
                sleep 5
                if [ $j -eq 30 ]; then
                  echo "‚ùå kafka-$idx agent not ready after 5 minutes"
                  ssh -o StrictHostKeyChecking=no root@$CONTROL_IP "ssh -o StrictHostKeyChecking=no root@$PRIVATE_IP 'tail -50 /var/log/cloud-init-output.log'" || true
                  exit 1
                fi
              done
            done
            
            echo ""
            echo "‚úÖ All $TOTAL_KAFKA Kafka nodes joined the cluster"
          else
            echo "Single Kafka node deployment - no additional nodes to process"
          fi
          
          echo ""
          echo "=========================================="
          echo "‚úÖ All verification steps completed successfully"
          echo "=========================================="

      - name: Deep Debug on Failure
        if: failure()
        run: |
          CONTROL_IP=${{ steps.tf_output.outputs.control_ip }}
          KAFKA_IP=${{ steps.tf_output.outputs.kafka_ip }}
          
          echo "============================================"
          echo "üîç COMPREHENSIVE DEBUG INFORMATION"
          echo "============================================"
          echo ""
          
          if [ -n "$CONTROL_IP" ]; then
            echo "============================================"
            echo "CONTROL PLANE: $CONTROL_IP"
            echo "============================================"
            
            echo ""
            echo "--- System Information ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "uname -a" 2>&1 || echo "‚ùå Cannot connect"
            
            echo ""
            echo "--- Cloud-init Status ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "cloud-init status --long" 2>&1 || echo "‚ùå Cloud-init status unavailable"
            
            echo ""
            echo "--- Full Cloud-init Output Log ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "cat /var/log/cloud-init-output.log" 2>&1 || echo "‚ùå Log unavailable"
            
            echo ""
            echo "--- Cloud-init Errors ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "grep -i error /var/log/cloud-init-output.log || echo 'No errors found'" 2>&1 || true
            
            echo ""
            echo "--- Files in /root ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "ls -laht /root/" 2>&1 || echo "‚ùå Cannot list files"
            
            echo ""
            echo "--- K3s Service Status ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "systemctl status k3s --no-pager" 2>&1 || echo "‚ùå K3s service not found"
            
            echo ""
            echo "--- K3s Service Logs (last 50 lines) ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "journalctl -u k3s -n 50 --no-pager" 2>&1 || echo "‚ùå K3s logs unavailable"
            
            echo ""
            echo "--- K3s Server Directory ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "ls -la /var/lib/rancher/k3s/server/" 2>&1 || echo "‚ùå Directory not found"
            
            echo ""
            echo "--- Running Processes ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "ps aux | grep -E 'k3s|helm|cloud-init' | grep -v grep" 2>&1 || echo "‚ùå Cannot list processes"
            
            echo ""
            echo "--- Disk Usage ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "df -h" 2>&1 || echo "‚ùå Cannot check disk"
            
            echo ""
            echo "--- Memory Usage ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "free -h" 2>&1 || echo "‚ùå Cannot check memory"
            
            echo ""
            echo "--- Network Interfaces ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "ip addr show" 2>&1 || echo "‚ùå Cannot show network"
            
            echo ""
            echo "--- Setup Script (if exists) ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$CONTROL_IP "cat /root/setup-k3s.sh" 2>&1 || echo "‚ùå Setup script not found"
          else
            echo "‚ùå CONTROL_IP not set - cannot debug control plane"
          fi
          
          echo ""
          echo "============================================"
          echo "KAFKA NODE: $KAFKA_IP"
          echo "============================================"
          
          if [ -n "$KAFKA_IP" ]; then
            echo ""
            echo "--- System Information ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "uname -a" 2>&1 || echo "‚ùå Cannot connect"
            
            echo ""
            echo "--- Cloud-init Status ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "cloud-init status --long" 2>&1 || echo "‚ùå Cloud-init status unavailable"
            
            echo ""
            echo "--- Full Cloud-init Output Log ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "cat /var/log/cloud-init-output.log" 2>&1 || echo "‚ùå Log unavailable"
            
            echo ""
            echo "--- Cloud-init Errors ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "grep -i error /var/log/cloud-init-output.log || echo 'No errors found'" 2>&1 || true
            
            echo ""
            echo "--- Files in /root ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "ls -laht /root/" 2>&1 || echo "‚ùå Cannot list files"
            
            echo ""
            echo "--- K3s Agent Service Status ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "systemctl status k3s-agent --no-pager" 2>&1 || echo "‚ùå K3s agent service not found"
            
            echo ""
            echo "--- K3s Agent Service Logs (last 50 lines) ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "journalctl -u k3s-agent -n 50 --no-pager" 2>&1 || echo "‚ùå K3s agent logs unavailable"
            
            echo ""
            echo "--- Token File Check ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "ls -la /tmp/k3s-token && echo 'Token content (masked):' && wc -c /tmp/k3s-token" 2>&1 || echo "‚ùå Token file not found"
            
            echo ""
            echo "--- Running Processes ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "ps aux | grep -E 'k3s|cloud-init' | grep -v grep" 2>&1 || echo "‚ùå Cannot list processes"
            
            echo ""
            echo "--- Disk Usage ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "df -h" 2>&1 || echo "‚ùå Cannot check disk"
            
            echo ""
            echo "--- Memory Usage ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "free -h" 2>&1 || echo "‚ùå Cannot check memory"
            
            echo ""
            echo "--- Network Interfaces ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "ip addr show" 2>&1 || echo "‚ùå Cannot show network"
            
            echo ""
            echo "--- Setup Script (if exists) ---"
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$KAFKA_IP "cat /root/setup-k3s-agent.sh" 2>&1 || echo "‚ùå Setup script not found"
          else
            echo "‚ùå KAFKA_IP not set - cannot debug kafka node"
          fi
          
          echo ""
          echo "============================================"
          echo "üîç DEBUG INFORMATION COLLECTION COMPLETE"
          echo "============================================"

