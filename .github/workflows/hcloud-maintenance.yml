name: hcloud-maintenance

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to target (dev|prod)"
        required: true
        default: "dev"
        type: choice
        options: [dev, prod]
      action:
        description: "Action to perform"
        required: true
        default: "list"
        type: choice
        options: [list, destroy-cluster, destroy-all, diagnose-argocd]

jobs:
  hcloud:
    runs-on: ubuntu-latest

    steps:
      - name: Install hcloud CLI
        run: |
          curl -fsSL https://github.com/hetznercloud/cli/releases/download/v1.47.0/hcloud-linux-amd64.tar.gz | tar -xz
          chmod +x hcloud
          sudo mv hcloud /usr/local/bin/
          hcloud version

      # ---------- LIST ----------
      - name: List all resources by env
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          set -euo pipefail
          ENV="${{ inputs.env }}"

          echo "========================================="
          echo "  Hetzner Cloud Resources: ${ENV}"
          echo "========================================="
          echo
          
          echo "== Primary IPs (Persistent) =="
          hcloud primary-ip list -l environment="$ENV" -o columns=id,name,ip,type,assignee_id,labels || echo "No Primary IPs found"
          
          echo
          echo "== Servers =="
          hcloud server list -l environment="$ENV" -o columns=id,name,ipv4,labels

          echo
          echo "== Volumes =="
          hcloud volume list -l environment="$ENV" -o columns=id,name,size,labels || echo "No volumes found"

          echo
          echo "== Load Balancers =="
          hcloud load-balancer list -l environment="$ENV" -o columns=id,name,labels || echo "No load balancers found"

          echo
          echo "== Floating IPs =="
          hcloud floating-ip list -l environment="$ENV" -o columns=id,description,ip,labels || echo "No Floating IPs found"

          echo
          echo "== SSH Keys =="
          hcloud ssh-key list -l environment="$ENV" -o columns=id,name,fingerprint,labels || echo "No SSH keys found"

          echo
          echo "== Networks =="
          hcloud network list -l environment="$ENV" -o columns=id,name,ip_range,labels || echo "No networks found"

          echo
          echo "== Firewalls =="
          hcloud firewall list -l environment="$ENV" -o columns=id,name,labels || echo "No firewalls found"
          
          echo
          echo "========================================="
          echo "üí° Tip: Primary IPs persist after VM destruction"
          echo "   Cost: ‚Ç¨0.50/month each (‚Ç¨1.00 total)"
          echo "========================================="
      
      # ---------- DESTROY CLUSTER (keep Primary IPs) ----------
      - name: Destroy cluster (keep Primary IPs for reuse)
        if: ${{ inputs.action == 'destroy-cluster' }}
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          set -euo pipefail
          ENV="${{ inputs.env }}"

          echo "========================================="
          echo "  Destroying Cluster (Keeping Primary IPs)"
          echo "========================================="
          echo
          echo "‚ö†Ô∏è  This will DELETE:"
          echo "   - All VMs (servers)"
          echo "   - Networks & Subnets"
          echo "   - Firewalls"
          echo "   - SSH Keys"
          echo "   - Volumes"
          echo "   - Load Balancers"
          echo
          echo "‚úÖ This will KEEP:"
          echo "   - Primary IPs (‚Ç¨1.00/month billing continues)"
          echo
          echo "Use this for daily cluster cleanup while preserving IPs"
          echo
          
          # Delete servers first
          mapfile -t SRVS < <(
            hcloud server list -l environment="$ENV" -o noheader -o columns=id \
            | sed '/^$/d'
          )
          if [ ${#SRVS[@]} -gt 0 ]; then
            echo "Deleting ${#SRVS[@]} servers..."
            hcloud server delete "${SRVS[@]}"
            echo "‚úÖ Servers deleted"
          else
            echo "No servers found"
          fi

          # Delete volumes
          mapfile -t VOLS < <(
            hcloud volume list -l environment="$ENV" -o noheader -o columns=id \
            | sed '/^$/d' || true
          )
          if [ ${#VOLS[@]} -gt 0 ]; then
            echo "Deleting ${#VOLS[@]} volumes..."
            hcloud volume delete "${VOLS[@]}"
            echo "‚úÖ Volumes deleted"
          else
            echo "No volumes found"
          fi

          # Delete load balancers
          mapfile -t LBS < <(
            hcloud load-balancer list -l environment="$ENV" -o noheader -o columns=id \
            | sed '/^$/d' || true
          )
          if [ ${#LBS[@]} -gt 0 ]; then
            echo "Deleting ${#LBS[@]} load balancers..."
            hcloud load-balancer delete "${LBS[@]}"
            echo "‚úÖ Load balancers deleted"
          else
            echo "No load balancers found"
          fi

          # Delete SSH keys
          mapfile -t SSHKEYS < <(
            hcloud ssh-key list -l environment="$ENV" -o noheader -o columns=id | sed '/^$/d' || true
          )
          if [ ${#SSHKEYS[@]} -gt 0 ]; then
            echo "Deleting ${#SSHKEYS[@]} SSH keys..."
            hcloud ssh-key delete "${SSHKEYS[@]}"
            echo "‚úÖ SSH keys deleted"
          else
            echo "No SSH keys found"
          fi

          # Delete networks
          mapfile -t NETS < <(
            hcloud network list -l environment="$ENV" -o noheader -o columns=id | sed '/^$/d' || true
          )
          if [ ${#NETS[@]} -gt 0 ]; then
            echo "Deleting ${#NETS[@]} networks..."
            hcloud network delete "${NETS[@]}"
            echo "‚úÖ Networks deleted"
          else
            echo "No networks found"
          fi

          # Delete firewalls
          mapfile -t FWS < <(
            hcloud firewall list -l environment="$ENV" -o noheader -o columns=id | sed '/^$/d' || true
          )
          if [ ${#FWS[@]} -gt 0 ]; then
            echo "Deleting ${#FWS[@]} firewalls..."
            hcloud firewall delete "${FWS[@]}"
            echo "‚úÖ Firewalls deleted"
          else
            echo "No firewalls found"
          fi
          
          echo
          echo "========================================="
          echo "‚úÖ Cluster Cleanup Complete!"
          echo "========================================="
          echo "Destroyed: VMs, Networks, Firewalls, SSH Keys, Volumes, Load Balancers"
          echo "Preserved: Primary IPs (still billing ‚Ç¨1.00/month)"
          echo "Next deployment will reuse the same IPs"
          echo
          
          # List remaining Primary IPs
          echo "Remaining Primary IPs:"
          hcloud primary-ip list -l environment="$ENV" -o columns=id,name,ip,assignee_id || echo "No Primary IPs found"
      
      # ---------- DESTROY ALL (including Primary IPs) ----------
      - name: Destroy ALL resources (including Primary IPs)
        if: ${{ inputs.action == 'destroy-all' }}
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          set -euo pipefail
          ENV="${{ inputs.env }}"

          echo "========================================="
          echo "  ‚ö†Ô∏è  DESTROYING ALL RESOURCES  ‚ö†Ô∏è"
          echo "========================================="
          echo
          echo "‚ö†Ô∏è  WARNING: This will DELETE EVERYTHING:"
          echo "   - All VMs (servers)"
          echo "   - Networks & Subnets"
          echo "   - Firewalls"
          echo "   - SSH Keys"
          echo "   - Volumes"
          echo "   - Load Balancers"
          echo "   - Primary IPs (‚ö†Ô∏è CANNOT BE RECOVERED)"
          echo
          echo "‚ö†Ô∏è  Primary IPs cannot be recovered once deleted!"
          echo "   Next deployment will get NEW random IPs"
          echo "   DNS will need to be updated"
          echo
          echo "Proceeding in 5 seconds..."
          sleep 5

          echo "Proceeding in 5 seconds..."
          sleep 5

          # ------------------------
          # 1) Delete servers first
          # ------------------------
          mapfile -t SRVS < <(
            hcloud server list -l environment="$ENV" -o noheader -o columns=id \
            | sed '/^$/d'
          )
          if [ ${#SRVS[@]} -gt 0 ]; then
            echo "Deleting ${#SRVS[@]} servers..."
            hcloud server delete "${SRVS[@]}"
          else
            echo "No servers found."
          fi

          # ------------------------
          # 2) Delete volumes
          # ------------------------
          mapfile -t VOLS < <(
            hcloud volume list -l environment="$ENV" -o noheader -o columns=id \
            | sed '/^$/d' || true
          )
          if [ ${#VOLS[@]} -gt 0 ]; then
            echo "Deleting ${#VOLS[@]} volumes..."
            hcloud volume delete "${VOLS[@]}"
          else
            echo "No volumes found."
          fi

          # ------------------------
          # 3) Delete load balancers
          # ------------------------
          mapfile -t LBS < <(
            hcloud load-balancer list -l environment="$ENV" -o noheader -o columns=id \
            | sed '/^$/d' || true
          )
          if [ ${#LBS[@]} -gt 0 ]; then
            echo "Deleting ${#LBS[@]} load balancers..."
            hcloud load-balancer delete "${LBS[@]}"
          else
            echo "No load balancers found."
          fi

          # ------------------------
          # 4) Delete floating IPs
          # ------------------------
          mapfile -t FIPS < <(
            hcloud floating-ip list -l environment="$ENV" -o noheader -o columns=id \
            | sed '/^$/d' || true
          )
          if [ ${#FIPS[@]} -gt 0 ]; then
            echo "Deleting ${#FIPS[@]} floating IPs..."
            hcloud floating-ip delete "${FIPS[@]}"
          else
            echo "No floating IPs found."
          fi
          
          # ------------------------
          # 5) Delete Primary IPs ‚ö†Ô∏è
          # ------------------------
          mapfile -t PIPS < <(
            hcloud primary-ip list -l environment="$ENV" -o noheader -o columns=id \
            | sed '/^$/d' || true
          )
          if [ ${#PIPS[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  Deleting ${#PIPS[@]} Primary IPs..."
            hcloud primary-ip delete "${PIPS[@]}"
            echo "‚úÖ Primary IPs deleted"
          else
            echo "No Primary IPs found."
          fi

          # ------------------------
          # 6) Delete SSH keys
          # ------------------------
          mapfile -t SSHKEYS < <(
            hcloud ssh-key list -l environment="$ENV" -o noheader -o columns=id | sed '/^$/d' || true
          )
          if [ ${#SSHKEYS[@]} -gt 0 ]; then
            echo "Deleting ${#SSHKEYS[@]} SSH keys..."
            hcloud ssh-key delete "${SSHKEYS[@]}"
          else
            echo "No SSH keys found."
          fi

          # ------------------------
          # 7) Delete networks
          # ------------------------
          mapfile -t NETS < <(
            hcloud network list -l environment="$ENV" -o noheader -o columns=id | sed '/^$/d' || true
          )
          if [ ${#NETS[@]} -gt 0 ]; then
            echo "Deleting ${#NETS[@]} networks..."
            hcloud network delete "${NETS[@]}"
          else
            echo "No networks found."
          fi

          # ------------------------
          # 8) Delete firewalls
          # ------------------------
          mapfile -t FWS < <(
            hcloud firewall list -l environment="$ENV" -o noheader -o columns=id | sed '/^$/d' || true
          )
          if [ ${#FWS[@]} -gt 0 ]; then
            echo "Deleting ${#FWS[@]} firewalls..."
            hcloud firewall delete "${FWS[@]}"
          else
            echo "No firewalls found."
          fi
          
          echo
          echo "========================================="
          echo "‚úÖ Complete Destruction Finished!"
          echo "========================================="
          echo "Destroyed: Everything (VMs, Networks, Firewalls, SSH Keys, Volumes, Load Balancers, Primary IPs)"
          echo "Next deployment will create new Primary IPs with random IPs"
          echo "‚ö†Ô∏è  Remember to update DNS with new IPs after next deployment"

      # ---------- DIAGNOSE ARGOCD ----------
      - name: Diagnose ArgoCD
        if: ${{ inputs.action == 'diagnose-argocd' }}
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          set -euo pipefail
          ENV="${{ inputs.env }}"
          
          echo "========================================="
          echo "  ArgoCD Diagnostics"
          echo "========================================="
          echo
          
          # Find control plane server
          echo "üîç Finding control plane server..."
          CONTROL_SERVER_ID=$(hcloud server list -l environment="$ENV" -l role=control-plane -o noheader -o columns=id | head -1)
          
          if [ -z "$CONTROL_SERVER_ID" ]; then
            echo "‚ùå No control plane server found for environment: $ENV"
            exit 1
          fi
          
          CONTROL_IP=$(hcloud server describe "$CONTROL_SERVER_ID" -o format='{{.PublicNet.IPv4.IP}}')
          echo "‚úÖ Control plane: $CONTROL_IP"
          echo
          
          # Get SSH key
          echo "üîë Setting up SSH..."
          SSH_KEY_ID=$(hcloud ssh-key list -l environment="$ENV" -o noheader -o columns=id | head -1)
          
          if [ -z "$SSH_KEY_ID" ]; then
            echo "‚ùå No SSH key found"
            exit 1
          fi
          
          # Create SSH key file
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          
          # Wait for SSH
          echo "‚è≥ Waiting for SSH connection..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /tmp/ssh_key root@$CONTROL_IP "echo SSH OK" 2>/dev/null; then
              echo "‚úÖ SSH connection established"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå SSH connection timeout"
              exit 1
            fi
            sleep 2
          done
          echo
          
          # Run diagnostics
          echo "========================================="
          echo "  Kubernetes & ArgoCD Status"
          echo "========================================="
          echo
          
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /tmp/ssh_key root@$CONTROL_IP << 'EOF'
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
            
            echo "== ArgoCD Pods =="
            kubectl get pods -n argocd -o wide
            echo
            
            echo "== ArgoCD Services =="
            kubectl get svc -n argocd
            echo
            
            echo "== ArgoCD Ingress =="
            kubectl get ingress -n argocd -o wide
            echo
            
            echo "== ArgoCD Server Logs (last 50 lines) =="
            kubectl logs -n argocd -l app.kubernetes.io/name=argocd-server --tail=50
            echo
            
            echo "== ArgoCD Application Controller Logs (last 30 lines) =="
            kubectl logs -n argocd -l app.kubernetes.io/name=argocd-application-controller --tail=30
            echo
            
            echo "== ArgoCD Applications =="
            kubectl get applications -n argocd
            echo
            
            echo "== ArgoCD ConfigMaps =="
            kubectl get configmap -n argocd argocd-cm -o yaml
            echo
            
            echo "== ArgoCD RBAC ConfigMap =="
            kubectl get configmap -n argocd argocd-rbac-cm -o yaml
            echo
            
            echo "== Check ArgoCD Server Health =="
            kubectl exec -n argocd deployment/argocd-server -- argocd admin settings rbac can admin applications list '*' || echo "RBAC check failed"
            echo
            
            echo "== Traefik Logs (last 30 lines) =="
            kubectl logs -n kube-system -l app.kubernetes.io/name=traefik --tail=30
            echo
            
            echo "== All Ingresses in Cluster =="
            kubectl get ingress --all-namespaces
            
          EOF
          
          echo
          echo "========================================="
          echo "‚úÖ Diagnostics Complete"
          echo "========================================="
          echo "ArgoCD UI: https://$CONTROL_IP"
          echo "If you see 'Internal Server Error', check the logs above"
