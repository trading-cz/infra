#cloud-config

write_files:
  - path: /root/setup-k3s-agent.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      exec > >(tee /root/cloud-init.log) 2>&1
      
      K3S_SERVER_IP="${k3s_server_ip}"
      
      echo "$(date): Starting K3s agent node setup"
      apt-get update -y
      apt-get install -y curl netcat
      
      echo "$(date): Waiting for K3s control plane at $K3S_SERVER_IP:6443..."
      for i in $(seq 1 60); do
        if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$K3S_SERVER_IP/6443" 2>/dev/null; then
          echo "$(date): Control plane K3s API is ready"
          break
        fi
        echo "$(date): Attempt $i/60: Waiting for control plane..."
        sleep 5
      done
      
      echo "$(date): Waiting for K3s token..."
      # Token will be pushed by GitHub Actions workflow after control plane is ready
      for i in $(seq 1 60); do
        if [ -f /tmp/k3s-token ]; then
          echo "$(date): Token file found"
          K3S_TOKEN=$(cat /tmp/k3s-token)
          if [ -n "$K3S_TOKEN" ]; then
            echo "$(date): Token retrieved successfully"
            break
          fi
        fi
        echo "$(date): Attempt $i/60: Waiting for token file /tmp/k3s-token..."
        sleep 5
      done
      
      echo "$(date): Installing K3s agent..."
      if [ -n "$K3S_TOKEN" ]; then
        curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable \
          K3S_URL="https://$K3S_SERVER_IP:6443" \
          K3S_TOKEN="$K3S_TOKEN" \
          sh -s - --node-label role=kafka
        echo "$(date): K3s agent installation completed"
      else
        echo "$(date): ERROR: Failed to retrieve K3s token"
        exit 1
      fi
      
      echo "$(date): Waiting for K3s agent to be ready..."
      # Note: systemctl is-active may report 'activating' for extended periods
      # Check process is running instead for reliability
      for i in $(seq 1 60); do
        if pgrep -f "k3s agent" > /dev/null 2>&1; then
          echo "$(date): K3s agent process is running"
          break
        fi
        echo "$(date): Attempt $i/60: Waiting for K3s agent process..."
        sleep 2
      done
      
      echo "$(date): Verifying K3s agent is running..."
      systemctl status k3s-agent --no-pager || true
      
      echo "$(date): K3s agent setup complete"
      echo "$(date): Node will appear in cluster shortly"
      echo "$(date): To label this node, run from control plane:"
      echo "  kubectl label node $(hostname) workload=kafka"
      
      touch /root/k3s-agent-ready.txt
      echo "$(date): Cloud-init completed successfully"

runcmd:
  - /root/setup-k3s-agent.sh
