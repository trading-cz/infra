#cloud-config

write_files:
  - path: /root/setup-k3s-agent.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      exec > >(tee /root/cloud-init.log) 2>&1
      
      K3S_SERVER_IP="${k3s_server_ip}"
      
      echo "$(date): Starting K3s agent node setup"
      apt-get update -y
      apt-get install -y curl netcat
      
      echo "$(date): Waiting for K3s control plane at $K3S_SERVER_IP:6443..."
      for i in $(seq 1 60); do
        if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$K3S_SERVER_IP/6443" 2>/dev/null; then
          echo "$(date): Control plane K3s API is ready"
          break
        fi
        echo "$(date): Attempt $i/60: Waiting for control plane..."
        sleep 5
      done
      
      echo "$(date): Waiting for K3s token..."
      # Token will be pushed by GitHub Actions workflow after control plane is ready
      for i in $(seq 1 60); do
        if [ -f /tmp/k3s-token ]; then
          echo "$(date): Token file found"
          K3S_TOKEN=$(cat /tmp/k3s-token)
          if [ -n "$K3S_TOKEN" ]; then
            echo "$(date): Token retrieved successfully"
            break
          fi
        fi
        echo "$(date): Attempt $i/60: Waiting for token file /tmp/k3s-token..."
        sleep 5
      done
      
      echo "$(date): Installing K3s agent..."
      if [ -n "$K3S_TOKEN" ]; then
        curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable \
          K3S_URL="https://$K3S_SERVER_IP:6443" \
          K3S_TOKEN="$K3S_TOKEN" sh -
        echo "$(date): K3s agent installation completed"
      else
        echo "$(date): ERROR: Failed to retrieve K3s token"
        exit 1
      fi
      
      echo "$(date): Waiting for K3s agent to be ready..."
      timeout 120 bash -c 'until systemctl is-active k3s-agent 2>/dev/null; do sleep 5; done'
      
      echo "$(date): Labeling node for Kafka workloads..."
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      NODE_NAME=$(hostname)
      
      # Wait for node to appear in cluster
      for i in $(seq 1 30); do
        if kubectl get node "$NODE_NAME" 2>/dev/null; then
          echo "$(date): Node registered in cluster"
          break
        fi
        echo "$(date): Attempt $i/30: Waiting for node registration..."
        sleep 2
      done
      
      # Add workload label for Strimzi Kafka
      if kubectl get node "$NODE_NAME" 2>/dev/null; then
        kubectl label node "$NODE_NAME" workload=kafka --overwrite 2>/dev/null || echo "Could not label node"
        echo "$(date): Node labeled with workload=kafka"
      else
        echo "$(date): WARNING: Node not found in cluster, skipping label"
      fi
      
      echo "$(date): K3s agent setup complete"
      touch /root/k3s-agent-ready.txt
      echo "$(date): Cloud-init completed successfully"

runcmd:
  - /root/setup-k3s-agent.sh
