#cloud-config

write_files:
  - path: /root/setup-k3s-agent.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      exec > >(tee /root/cloud-init.log) 2>&1
      
      K3S_SERVER_IP="${k3s_server_ip}"
      
      echo "$(date): Starting K3s agent node setup"
      apt-get update -y
      apt-get install -y curl netcat
      
      echo "$(date): Waiting for K3s control plane at $K3S_SERVER_IP:6443..."
      for i in $(seq 1 60); do
        if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$K3S_SERVER_IP/6443" 2>/dev/null; then
          echo "$(date): Control plane K3s API is ready"
          break
        fi
        echo "$(date): Attempt $i/60: Waiting for control plane..."
        sleep 5
      done
      
      echo "$(date): Retrieving K3s node token..."
      for i in $(seq 1 24); do
        K3S_TOKEN=$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o BatchMode=yes root@$K3S_SERVER_IP "cat /var/lib/rancher/k3s/server/node-token" 2>/dev/null)
        if [ -n "$K3S_TOKEN" ]; then
          echo "$(date): Token retrieved successfully"
          echo "$K3S_TOKEN" > /tmp/k3s-token
          break
        fi
        echo "$(date): Attempt $i/24: Waiting for token..."
        sleep 5
      done
      
      echo "$(date): Installing K3s agent..."
      if [ -f /tmp/k3s-token ]; then
        K3S_TOKEN=$(cat /tmp/k3s-token)
        curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable K3S_URL="https://$K3S_SERVER_IP:6443" K3S_TOKEN="$K3S_TOKEN" sh -
      else
        echo "$(date): ERROR: Failed to retrieve K3s token"
        exit 1
      fi
      
      echo "$(date): Waiting for K3s agent to be ready..."
      timeout 120 bash -c 'until systemctl is-active k3s-agent 2>/dev/null; do sleep 5; done'
      
      echo "$(date): K3s agent setup complete"
      touch /root/k3s-agent-ready.txt
      echo "$(date): Cloud-init completed successfully"

runcmd:
  - /root/setup-k3s-agent.sh
