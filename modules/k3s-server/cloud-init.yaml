#cloud-config

write_files:
  - path: /root/setup-k3s.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e  # Exit on error
      
      # ============================================
      # Install K3s Server
      # ============================================
      echo "$(date): Installing K3s server..."
      curl -sfL https://get.k3s.io | sh -s - \
        --write-kubeconfig-mode 644 \
        --disable servicelb \
        --disable traefik \
        --tls-san $(curl -s http://169.254.169.254/hetzner/v1/metadata/public-ipv4)
      
      # Export kubeconfig for kubectl and helm
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      
      # Wait for K3s to be ready
      echo "$(date): Waiting for K3s to be ready..."
      until kubectl get nodes 2>/dev/null; do
        echo "Waiting for K3s API..."
        sleep 2
      done
      
      # Wait for node to be ready (not just registered)
      echo "$(date): Waiting for node to be Ready..."
      until kubectl wait --for=condition=Ready node --all --timeout=60s 2>/dev/null; do
        echo "Node not ready yet..."
        sleep 5
      done
      
      echo "$(date): K3s server is ready"
      kubectl get nodes

      # ============================================
      # Install Helm 3
      # ============================================
      echo "$(date): Installing Helm 3..."
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      
      # ============================================
      # Install Traefik (Helm)
      # ============================================
      echo "$(date): Installing Traefik..."
      helm repo add traefik https://traefik.github.io/charts
      helm repo update
      helm install traefik traefik/traefik \
        --namespace kube-system \
        --set ports.web.nodePort=30080 \
        --set ports.websecure.nodePort=30443 \
        --set service.type=NodePort
      
      # ============================================
      # Install Prometheus Operator (Helm)
      # ============================================
      echo "$(date): Installing Prometheus Operator v0.77.0..."
      helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      helm repo update
      helm install prometheus-operator prometheus-community/kube-prometheus-stack \
        --namespace monitoring \
        --create-namespace \
        --set prometheus.prometheusSpec.retention=30d \
        --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=20Gi \
        --set grafana.enabled=false \
        --set alertmanager.enabled=false \
        --wait \
        --timeout 5m
      echo "$(date): Verifying Prometheus Operator installation..."
      echo "$(date): Checking monitoring namespace pods..."
      kubectl get pods -n monitoring -o wide
      echo "$(date): Checking Prometheus Operator deployment..."
      kubectl describe deployment -n monitoring prometheus-operator 2>/dev/null || true
      echo "$(date): Waiting for Prometheus Operator controller to be ready..."
      # kube-prometheus-stack creates pod with label: app.kubernetes.io/name=prometheus-operator
      if kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=prometheus-operator -n monitoring --timeout=60s 2>/dev/null; then
        echo "$(date): Prometheus Operator controller is ready"
      else
        echo "$(date): Waiting for pod deployment..."
        # Check if deployment exists and pod is pending
        if kubectl get deployment -n monitoring prometheus-operator 2>/dev/null; then
          echo "$(date): Deployment exists, checking pod events..."
          kubectl describe pod -n monitoring -l app.kubernetes.io/name=prometheus-operator 2>/dev/null || true
          # Check for image pull or node resource issues
          kubectl get events -n monitoring --sort-by='.lastTimestamp' --field-selector=type!=Normal 2>/dev/null || true
          echo "$(date): Waiting additional 30s for pod to start..."
          sleep 30
        else
          echo "$(date): Warning - Prometheus Operator deployment not found"
        fi
        kubectl logs -n monitoring -l app.kubernetes.io/name=prometheus-operator --tail=50 2>/dev/null || echo "No operator logs yet"
      fi
      sleep 5
      
      # ============================================
      # Install Grafana Operator (Helm)
      # ============================================
      echo "$(date): Installing Grafana Operator v5.21.3..."
      helm repo add grafana https://grafana.github.io/helm-charts
      helm repo update
      helm install grafana-operator grafana/grafana-operator \
        --namespace monitoring \
        --wait \
        --timeout 5m
      echo "$(date): Verifying Grafana Operator installation..."
      echo "$(date): Checking monitoring namespace pods..."
      kubectl get pods -n monitoring -o wide
      echo "$(date): Waiting for Grafana Operator to be ready..."
      if kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=grafana-operator -n monitoring --timeout=300s 2>/dev/null; then
        echo "$(date): Grafana Operator is ready"
      else
        echo "$(date): Warning - Grafana Operator not ready yet, checking pod status..."
        kubectl get pods -n monitoring -o wide
        kubectl describe pods -n monitoring -l app.kubernetes.io/name=grafana-operator 2>/dev/null || true
        kubectl logs -n monitoring -l app.kubernetes.io/name=grafana-operator --tail=50 2>/dev/null || true
        echo "$(date): Continuing deployment..."
      fi
      sleep 10
      
      # Final verification - show all monitoring namespace resources
      echo "$(date): Final monitoring namespace status..."
      kubectl get all -n monitoring
      kubectl get crd | grep -E 'prometheus|grafana|monitoring' || echo "$(date): Warning - Some CRDs not yet available"
      
      echo "$(date): K3s control plane setup complete"
      touch /root/k3s-ready.txt
      
      kubectl get nodes
      kubectl get pods -A
      echo "$(date): Cloud-init completed successfully"

runcmd:
  - /root/setup-k3s.sh
