#cloud-config

write_files:
  - path: /root/setup-k3s.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      exec > >(tee /root/cloud-init.log) 2>&1
      OLM_VERSION="v0.26.0"
      ARGOCD_OPERATOR_MANIFEST_DIR="/root/argocd-operator"
      
      echo "$(date): Starting K3s control plane installation"
      apt-get update -y
      apt-get install -y curl
      
      install_olm() {
        if kubectl get namespace olm >/dev/null 2>&1; then
          echo "$(date): OLM already installed"
          return
        fi

        echo "$(date): Installing Operator Lifecycle Manager (${OLM_VERSION})..."
        local olm_manifest="/root/olm-${OLM_VERSION}.yaml"
        curl -sSL -o "${olm_manifest}" "https://github.com/operator-framework/operator-lifecycle-manager/releases/download/${OLM_VERSION}/install.yaml"
        kubectl apply -f "${olm_manifest}"

        echo "$(date): Waiting for OLM deployments..."
        kubectl -n olm rollout status deployment/olm-operator --timeout=300s
        kubectl -n olm rollout status deployment/catalog-operator --timeout=300s
        kubectl -n olm rollout status deployment/packageserver --timeout=300s
      }

      render_argocd_operator_manifests() {
        echo "$(date): Rendering Argo CD operator manifests..."
        mkdir -p "${ARGOCD_OPERATOR_MANIFEST_DIR}"

        cat <<'EOF' > "${ARGOCD_OPERATOR_MANIFEST_DIR}/catalog-source.yaml"
# c:\projects\git-public\infra\templates\argocd-operator\catalog-source.yaml
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: argocd-catalog
  namespace: olm
spec:
  sourceType: grpc
  image: quay.io/argoprojlabs/argocd-operator-registry:v0.15.0
  displayName: Argo CD Operators
  publisher: Argo CD Community
EOF

        cat <<'EOF' > "${ARGOCD_OPERATOR_MANIFEST_DIR}/operator-group.yaml"
# c:\projects\git-public\infra\templates\argocd-operator\operator-group.yaml
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: argocd-operator
  namespace: argocd
spec:
  targetNamespaces:
    - argocd
EOF

        cat <<'EOF' > "${ARGOCD_OPERATOR_MANIFEST_DIR}/subscription.yaml"
# c:\projects\git-public\infra\templates\argocd-operator\subscription.yaml
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: argocd-operator
  namespace: argocd
spec:
  channel: alpha
  name: argocd-operator
  source: argocd-catalog
  sourceNamespace: olm
  installPlanApproval: Automatic
  config:
    env:
      - name: ARGOCD_CLUSTER_CONFIG_NAMESPACES
        value: argocd
EOF

        cat <<'EOF' > "${ARGOCD_OPERATOR_MANIFEST_DIR}/kustomization.yaml"
# c:\projects\git-public\infra\templates\argocd-operator\kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - catalog-source.yaml
  - operator-group.yaml
  - subscription.yaml
EOF
      }

      deploy_argocd_operator() {
        echo "$(date): Deploying Argo CD operator via OLM..."
        kubectl get namespace argocd >/dev/null 2>&1 || kubectl create namespace argocd
        kubectl apply -k "${ARGOCD_OPERATOR_MANIFEST_DIR}"

        echo "$(date): Waiting for Argo CD operator controller manager..."
        kubectl rollout status deployment/argocd-operator-controller-manager -n argocd --timeout=300s
      }

      echo "$(date): Installing K3s server..."
      curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable INSTALL_K3S_EXEC="server --cluster-init" sh -
      
      echo "$(date): Waiting for K3s to be ready..."
      timeout 300 bash -c 'until kubectl get nodes 2>/dev/null; do sleep 5; done'
      
      chmod 644 /etc/rancher/k3s/k3s.yaml
      
      # Set KUBECONFIG for all subsequent kubectl and helm commands
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      echo "$(date): K3s ready"
      
      # ============================================
      # Install Helm 3
      # ============================================
      echo "$(date): Installing Helm 3..."
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      
      # ============================================
      # Install Strimzi Kafka Operator
      # ============================================
      echo "$(date): Installing Strimzi Kafka Operator..."
      
      helm repo add strimzi https://strimzi.io/charts/
      helm repo update
      
      helm install strimzi-kafka-operator strimzi/strimzi-kafka-operator \
        --namespace kafka \
        --create-namespace \
        --version 0.48.0 \
        --set watchAnyNamespace=true \
        --set resources.requests.memory=128Mi \
        --set resources.requests.cpu=100m \
        --set resources.limits.memory=512Mi \
        --set resources.limits.cpu=500m \
        --set logLevel=INFO \
        --wait
      
      echo "$(date): Verifying Strimzi installation..."
      kubectl get pods -n kafka
      kubectl get crd | grep kafka || echo "Strimzi CRDs installed"
      
      # ============================================
      # Install OLM + Argo CD Operator
      # ============================================
      install_olm
      render_argocd_operator_manifests
      deploy_argocd_operator
      
      echo "$(date): K3s control plane setup complete"
      touch /root/k3s-ready.txt
      
      kubectl get nodes
      kubectl get pods -A
      echo "$(date): Cloud-init completed successfully"

runcmd:
  - /root/setup-k3s.sh
