#cloud-config

write_files:
  - path: /root/setup-k3s.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      exec > >(tee /root/cloud-init.log) 2>&1
      
      echo "$(date): Starting K3s control plane installation"
      apt-get update -y
      apt-get install -y curl
      
      echo "$(date): Installing K3s server..."
      curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable INSTALL_K3S_EXEC="server --cluster-init --disable traefik" sh -
      
      echo "$(date): Waiting for K3s to be ready..."
      timeout 300 bash -c 'until kubectl get nodes 2>/dev/null; do sleep 5; done'
      
      chmod 644 /etc/rancher/k3s/k3s.yaml
      echo "$(date): K3s ready"
      
      echo "$(date): Installing ArgoCD..."
      kubectl create namespace argocd
      kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      
      echo "$(date): Waiting for ArgoCD server..."
      timeout 300 bash -c 'until kubectl get pod -n argocd -l app.kubernetes.io/name=argocd-server 2>/dev/null | grep Running; do sleep 5; done'
      
      echo "$(date): K3s control plane setup complete"
      touch /root/k3s-ready.txt
      
      kubectl get nodes
      kubectl get pods -A
      echo "$(date): Cloud-init completed successfully"

runcmd:
  - /root/setup-k3s.sh
