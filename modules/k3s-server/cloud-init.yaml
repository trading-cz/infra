#cloud-config

write_files:
  - path: /root/setup-k3s.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e  # Exit on error
      
      # ============================================
      # Install K3s Server
      # ============================================
      echo "$(date): Installing K3s server..."
      curl -sfL https://get.k3s.io | sh -s - \
        --write-kubeconfig-mode 644 \
        --disable traefik \
        --disable servicelb
      
      # Wait for K3s to be ready
      echo "$(date): Waiting for K3s to be ready..."
      until kubectl get nodes 2>/dev/null; do
        echo "Waiting for K3s API..."
        sleep 2
      done
      
      echo "$(date): K3s server is ready"
      kubectl get nodes

      # ============================================
      # Install Helm 3
      # ============================================
      echo "$(date): Installing Helm 3..."
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      
      # ============================================
      # Install Strimzi Kafka Operator
      # ============================================
      echo "$(date): Installing Strimzi Kafka Operator..."
      
      helm repo add strimzi https://strimzi.io/charts/
      helm repo update
      
      helm install strimzi-kafka-operator strimzi/strimzi-kafka-operator \
        --namespace kafka \
        --create-namespace \
        --version 0.48.0 \
        --set watchAnyNamespace=true \
        --set resources.requests.memory=128Mi \
        --set resources.requests.cpu=100m \
        --set resources.limits.memory=512Mi \
        --set resources.limits.cpu=500m \
        --set logLevel=INFO \
        --wait
      
      echo "$(date): Verifying Strimzi installation..."
      kubectl get pods -n kafka
      kubectl get crd | grep kafka || echo "Strimzi CRDs installed"
      
      echo "$(date): K3s control plane setup complete"
      touch /root/k3s-ready.txt
      
      kubectl get nodes
      kubectl get pods -A
      echo "$(date): Cloud-init completed successfully"

runcmd:
  - /root/setup-k3s.sh
